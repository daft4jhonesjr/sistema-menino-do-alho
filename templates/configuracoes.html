{% extends 'base.html' %}
{% block title %}Configura√ß√µes do Site - Menino do Alho{% endblock %}
{% block content %}
<div class="container mx-auto px-4 py-8 max-w-4xl">
    <h2 class="text-3xl font-bold text-emerald-700 dark:text-emerald-400 mb-2">Configura√ß√µes do Site</h2>
    <p class="text-gray-600 dark:text-gray-400 mb-6">Personalize a apar√™ncia e o comportamento do sistema.</p>

    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 p-6">
        <h3 class="text-lg font-bold text-emerald-700 dark:text-emerald-500 border-b border-gray-100 dark:border-gray-700 pb-2 mb-4">Apar√™ncia e Visualiza√ß√£o</h3>

        <div class="mb-6">
            <label class="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-2">Tema do Sistema (Modo Escuro)</label>
            <p class="text-sm text-gray-500 dark:text-gray-400 mb-4">Escolha como o sistema deve se comportar visualmente.</p>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <label class="cursor-pointer">
                    <input type="radio" name="theme_selector" value="claro" class="peer sr-only">
                    <div class="rounded-lg border-2 border-gray-200 bg-white p-4 text-gray-700 peer-checked:border-emerald-500 peer-checked:bg-emerald-50 hover:bg-gray-50 transition-all text-center">
                        <div class="text-2xl mb-2">‚òÄÔ∏è</div>
                        <div class="font-bold">Modo Claro</div>
                    </div>
                </label>

                <label class="cursor-pointer">
                    <input type="radio" name="theme_selector" value="escuro" class="peer sr-only">
                    <div class="rounded-lg border-2 border-gray-700 bg-gray-800 p-4 text-gray-300 peer-checked:border-emerald-500 peer-checked:bg-gray-700 hover:bg-gray-700 transition-all text-center">
                        <div class="text-2xl mb-2">üåô</div>
                        <div class="font-bold">Modo Escuro</div>
                    </div>
                </label>

                <label class="cursor-pointer">
                    <input type="radio" name="theme_selector" value="auto" class="peer sr-only">
                    <div class="rounded-lg border-2 border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800 p-4 text-gray-700 dark:text-gray-300 peer-checked:border-emerald-500 peer-checked:bg-emerald-50 dark:peer-checked:bg-gray-700 hover:bg-gray-100 dark:hover:bg-gray-700 transition-all text-center">
                        <div class="text-2xl mb-2">‚è≥</div>
                        <div class="font-bold">Hor√°rio do Dia</div>
                        <div class="text-xs mt-1 text-gray-500">(Escuro ap√≥s as 18h)</div>
                    </div>
                </label>
            </div>
        </div>

        <h3 class="text-lg font-bold text-emerald-700 dark:text-emerald-500 border-b border-gray-100 dark:border-gray-700 pb-2 mb-4 mt-8">Alertas e Notifica√ß√µes</h3>

        <form method="POST" action="{{ url_for('configuracoes') }}" class="mb-6">
            <div class="bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700">
                <div class="px-5 py-4 border-b border-gray-200 dark:border-gray-700">
                    <h3 class="text-lg font-semibold text-emerald-800 dark:text-emerald-400">Prefer√™ncias de Notifica√ß√£o</h3>
                </div>
                <div class="p-5 space-y-5">
                    <div class="flex items-center justify-between">
                        <div>
                            <h4 class="text-sm font-semibold text-gray-900 dark:text-white">Vencimento de Boletos</h4>
                            <p class="text-xs text-gray-500 dark:text-gray-400">Receba alertas di√°rios sobre clientes com pagamentos vencendo hoje.</p>
                        </div>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" name="notifica_boletos" value="true" class="sr-only peer" {% if usuario and usuario.notifica_boletos %}checked{% endif %} onchange="this.form.submit()">
                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-emerald-600"></div>
                        </label>
                    </div>
                    <hr class="border-gray-100 dark:border-gray-700">
                    <div class="flex items-center justify-between">
                        <div>
                            <h4 class="text-sm font-semibold text-gray-900 dark:text-white">Radar de Recompra</h4>
                            <p class="text-xs text-gray-500 dark:text-gray-400">Seja avisado quando um cliente chegar no dia previsto para fazer um novo pedido.</p>
                        </div>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" name="notifica_radar" value="true" class="sr-only peer" {% if usuario and usuario.notifica_radar %}checked{% endif %} onchange="this.form.submit()">
                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-emerald-600"></div>
                        </label>
                    </div>
                    <hr class="border-gray-100 dark:border-gray-700">
                    <div class="flex items-center justify-between">
                        <div>
                            <h4 class="text-sm font-semibold text-gray-900 dark:text-white">Resumo de Log√≠stica</h4>
                            <p class="text-xs text-gray-500 dark:text-gray-400">Receba um resumo com as entregas programadas para o dia e rotas otimizadas.</p>
                        </div>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" name="notifica_logistica" value="true" class="sr-only peer" {% if usuario and usuario.notifica_logistica %}checked{% endif %} onchange="this.form.submit()">
                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-emerald-600"></div>
                        </label>
                    </div>
                </div>
            </div>
        </form>

        <div class="mb-6 flex items-center justify-between bg-gray-50 dark:bg-gray-800/50 p-4 rounded-lg border border-gray-200 dark:border-gray-700">
            <div>
                <h4 class="font-bold text-gray-800 dark:text-white flex items-center gap-2">
                    <span>üì≤</span> Notifica√ß√µes no Dispositivo
                </h4>
                <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Receba alertas na tela do celular ou computador quando houver cobran√ßas vencendo hoje.</p>
            </div>
            <label class="relative inline-flex items-center cursor-pointer">
                <input type="checkbox" id="toggleNotificacoes" class="sr-only peer">
                <div class="w-11 h-6 bg-gray-300 peer-focus:outline-none rounded-full peer dark:bg-gray-600 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-emerald-500"></div>
            </label>
        </div>

        {% if current_user.is_admin() %}
        <h3 class="text-lg font-bold text-emerald-700 dark:text-emerald-500 border-b border-gray-100 dark:border-gray-700 pb-2 mb-4 mt-8">Gerenciamento do Sistema</h3>

        <div class="mb-6 grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="border border-gray-200 dark:border-gray-700 rounded-lg p-4 bg-gray-50 dark:bg-gray-800/50 flex flex-col justify-between">
                <div>
                    <div class="flex items-center mb-2">
                        <span class="text-2xl mr-3">üìÅ</span>
                        <h4 class="font-bold text-gray-800 dark:text-white">Arquivos do Banco</h4>
                    </div>
                    <p class="text-sm text-gray-500 dark:text-gray-400 mb-4">Gerencie, visualize e limpe os PDFs (boletos e comprovantes) armazenados no banco de dados do sistema.</p>
                </div>
                <a href="{{ url_for('admin_arquivos') }}" class="w-full inline-block text-center bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-200 font-bold py-2 px-4 rounded hover:bg-gray-100 dark:hover:bg-gray-600 transition-colors">
                    Acessar Arquivos
                </a>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    var radios = document.querySelectorAll('input[name="theme_selector"]');
    var currentTheme = localStorage.getItem('menino_alho_theme') || 'auto';

    radios.forEach(function(r) {
        if (r.value === currentTheme) r.checked = true;

        r.addEventListener('change', function(e) {
            var val = e.target.value;
            localStorage.setItem('menino_alho_theme', val);

            var isDark = false;
            if (val === 'escuro') {
                isDark = true;
            } else if (val === 'auto') {
                var hour = new Date().getHours();
                isDark = (hour >= 18 || hour < 6);
            }

            if (isDark) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });
    });

    // L√≥gica das Notifica√ß√µes de Dispositivo
    var toggleNotif = document.getElementById('toggleNotificacoes');
    if (toggleNotif) {
        if (localStorage.getItem('menino_alho_device_notif') === 'true' && typeof Notification !== 'undefined' && Notification.permission === 'granted') {
            toggleNotif.checked = true;
        }
        toggleNotif.addEventListener('change', async function(e) {
            if (e.target.checked) {
                if (!("Notification" in window)) {
                    alert("Seu navegador n√£o suporta notifica√ß√µes de sistema.");
                    e.target.checked = false;
                    return;
                }
                try {
                    var permission = await Notification.requestPermission();
                    if (permission === "granted") {
                        localStorage.setItem('menino_alho_device_notif', 'true');
                        new Notification("Menino do Alho", {
                            body: "Notifica√ß√µes ativadas com sucesso! Voc√™ ser√° avisado sobre cobran√ßas.",
                            icon: "{{ url_for('static', filename='images/logo_menino_do_alho_amarelo1.jpeg') }}"
                        });
                    } else {
                        e.target.checked = false;
                        localStorage.setItem('menino_alho_device_notif', 'false');
                        alert("Voc√™ precisa permitir as notifica√ß√µes nas configura√ß√µes do seu navegador/celular para usar este recurso.");
                    }
                } catch (err) {
                    e.target.checked = false;
                    localStorage.setItem('menino_alho_device_notif', 'false');
                }
            } else {
                localStorage.setItem('menino_alho_device_notif', 'false');
            }
        });
    }
});
</script>
{% endblock %}
