{% if pedidos %}
{% for pedido in pedidos %}
{% set zebra_class = 'bg-white dark:bg-gray-800' if loop.index % 2 == 0 else 'bg-emerald-50/50 dark:bg-emerald-900/20' %}
{% set zebra_bg_class = 'bg-white dark:bg-gray-800' if loop.index % 2 == 0 else 'bg-emerald-50/30 dark:bg-emerald-900/30' %}
{% set row_vencida = pedido.is_vencido %}
{% set pedido_unique_id = 'pedido-' ~ pedido.primeira_venda_id %}
<!-- Linha de Resumo do Pedido (Expansível) -->
<tr class="pedido-resumo cursor-pointer transition {{ 'linha-vencida-abatimento' if row_vencida else zebra_class }} {{ 'hover:bg-red-100 dark:hover:bg-red-900/40' if row_vencida else 'hover:bg-emerald-100 dark:hover:bg-emerald-900/40' }}" data-pedido-id="{{ pedido_unique_id }}" data-venda-ids="{{ pedido.vendas|map(attribute='id')|list|tojson }}" data-lucro-total="{{ pedido.total_lucro }}">
    <td class="px-3 py-4 text-center" onclick="event.stopPropagation();">
        <input type="checkbox" class="bulk-row-check rounded border-gray-300 dark:border-gray-600 text-emerald-600 focus:ring-emerald-500" data-venda-ids="{{ pedido.vendas|map(attribute='id')|list|tojson }}" data-lucro-total="{{ pedido.total_lucro }}">
    </td>
    <td class="px-4 py-4 text-center">
        <i data-lucide="chevron-down" class="w-5 h-5 text-emerald-700 dark:text-emerald-400 pedido-chevron transition-transform"></i>
    </td>
    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 dark:text-gray-100">{{ pedido.data_venda.strftime('%d/%m') }}</td>
    <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-gray-900 dark:text-gray-100">{{ pedido.cliente_nome }}</td>
    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-gray-100">{{ pedido.nf }}</td>
    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-gray-100 text-right">{% if pedido.total_quantidade and pedido.total_quantidade != 0 %}{{ (pedido.total_valor / pedido.total_quantidade)|formato_moeda }}{% else %}<span class="text-gray-400 dark:text-gray-500">---</span>{% endif %}</td>
    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 dark:text-gray-100 text-right">{{ pedido.total_quantidade }}</td>
    <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-gray-900 dark:text-gray-100 text-right">{{ pedido.total_valor|formato_moeda }}</td>
    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-right {% if pedido.total_lucro >= 0 %}text-emerald-600 dark:text-emerald-400{% else %}text-red-600 dark:text-red-400{% endif %}">{{ pedido.total_lucro|formato_moeda }}</td>
    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-gray-100">
        {% if pedido.data_vencimento %}
            {{ pedido.data_vencimento.strftime('%d/%m/%Y') }}
            {% if row_vencida %}
                <i data-lucide="alert-triangle" class="w-4 h-4 inline-block ml-1 text-red-600 dark:text-red-400 alerta-vencido-pulse" title="Vencido — pagamento pendente"></i>
            {% endif %}
        {% else %}
            <span class="text-gray-400 dark:text-gray-500">---</span>
        {% endif %}
    </td>
    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-gray-100">{{ pedido.empresa_faturadora }}</td>
    <td class="px-6 py-4 whitespace-nowrap text-center">
        {% if pedido.situacao == 'PENDENTE' %}
        <button type="button" class="badge-situacao-toggle px-3 py-1 text-xs font-semibold rounded-full bg-amber-100 dark:bg-amber-900/50 text-amber-800 dark:text-amber-300 cursor-pointer hover:bg-amber-200 dark:hover:bg-amber-800 hover:ring-2 hover:ring-amber-400 transition focus:outline-none focus:ring-2 focus:ring-amber-400" data-venda-id="{{ pedido.primeira_venda_id }}" data-nf="{{ pedido.nf if pedido.nf and pedido.nf != '-' else 'N/A' }}" data-situacao="PENDENTE" data-cliente="{{ pedido.cliente_nome }}" data-valor="{{ pedido.total_valor|formato_moeda }}" title="Clique para marcar como pago">{{ pedido.situacao }}</button>
        {% elif pedido.situacao == 'PARCIAL' %}
        <span class="inline-block px-3 py-1 text-xs font-semibold rounded-full bg-orange-100 dark:bg-orange-900/50 text-orange-800 dark:text-orange-300">{{ pedido.situacao }}</span>
        {% if pedido.total_valor_pago and pedido.total_valor_pago > 0 %}
        <span class="block text-[10px] text-orange-600 dark:text-orange-400 mt-0.5">(Pago: {{ pedido.total_valor_pago|formato_moeda }})</span>
        {% endif %}
        {% else %}
        <button type="button" class="badge-situacao-toggle px-3 py-1 text-xs font-semibold rounded-full bg-emerald-100 dark:bg-emerald-900/50 text-emerald-800 dark:text-emerald-300 cursor-pointer hover:bg-emerald-200 dark:hover:bg-emerald-800 hover:ring-2 hover:ring-emerald-400 transition focus:outline-none focus:ring-2 focus:ring-emerald-400" data-venda-id="{{ pedido.primeira_venda_id }}" data-nf="{{ pedido.nf if pedido.nf and pedido.nf != '-' else 'N/A' }}" data-situacao="PAGO" data-cliente="{{ pedido.cliente_nome }}" data-valor="{{ pedido.total_valor|formato_moeda }}" title="Clique para reverter para pendente">{{ pedido.situacao }}</button>
        {% endif %}
    </td>
    <td class="px-6 py-4 whitespace-nowrap text-center">
        {% if pedido.forma_pagamento %}
        <span class="px-2 py-1 text-xs font-semibold rounded-full {% if pedido.forma_pagamento|upper == 'BOLETO' %}bg-blue-100 text-blue-800 dark:bg-blue-900/40 dark:text-blue-300{% else %}bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-200{% endif %}">
            {{ pedido.forma_pagamento }}
        </span>
        {% else %}
        --
        {% endif %}
    </td>
    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium min-w-[180px]" onclick="event.stopPropagation();">
        <div class="flex items-center justify-end gap-1.5 flex-nowrap">
            {# 1. WHATSAPP: Link direto (imune a bloqueador de pop-ups) #}
            <a href="{{ url_for('enviar_whatsapp_boleto', id=pedido.primeira_venda_id) }}" target="_blank" rel="noopener noreferrer" class="flex-shrink-0 p-1.5 rounded text-green-600 dark:text-green-400 hover:text-green-700 dark:hover:text-green-300 hover:bg-green-50 dark:hover:bg-green-900/30 inline-flex transition-colors" title="Enviar cobrança com link do boleto no WhatsApp">
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/></svg>
            </a>
            {# 2. NOTA FISCAL: Visualizar (quando documento vinculado) #}
            {% if pedido.caminho_nf %}
            {% set _doc_nf = pedido.doc_nf %}
            {% set _url_nf = url_for('ver_nf_venda', id=pedido.primeira_venda_id) %}
            <a href="{{ _url_nf }}" target="_blank" rel="noopener noreferrer" class="flex-shrink-0 p-1.5 rounded inline-flex transition-colors {{ 'text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300 hover:bg-blue-50 dark:hover:bg-blue-900/30' if _doc_nf else 'text-orange-600 dark:text-orange-400 hover:text-orange-800 dark:hover:text-orange-300 hover:bg-orange-50 dark:hover:bg-orange-900/30 cursor-help' }}" title="{{ 'Visualizar Nota Fiscal' if _doc_nf else 'Visualizar Nota Fiscal (vínculo órfão)' }}">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
            </a>
            {% endif %}
            {# 3. BOLETO: Visualizar (quando documento vinculado) #}
            {% if pedido.caminho_boleto %}
            {% set _doc_boleto = pedido.doc_boleto %}
            {% set _url_boleto = url_for('ver_boleto_venda', id=pedido.primeira_venda_id) %}
            <a href="{{ _url_boleto }}" target="_blank" rel="noopener noreferrer" class="flex-shrink-0 p-1.5 rounded inline-flex transition-colors {{ 'text-amber-600 dark:text-amber-400 hover:text-amber-700 dark:hover:text-amber-300 hover:bg-amber-50 dark:hover:bg-amber-900/30' if _doc_boleto else 'text-orange-600 dark:text-orange-400 hover:text-orange-800 dark:hover:text-orange-300 hover:bg-orange-50 dark:hover:bg-orange-900/30 cursor-help' }}" title="{{ 'Visualizar Boleto' if _doc_boleto else 'Visualizar Boleto (vínculo órfão)' }}">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M3 14h18m-9-4v8m-7 0h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
            </a>
            {% endif %}
            {# 4. RECIBO: Imprimir (sempre disponível) #}
            <a href="{{ url_for('recibo_venda', id=pedido.primeira_venda_id) }}" target="_blank" rel="noopener noreferrer" class="flex-shrink-0 p-1.5 rounded text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300 hover:bg-blue-50 dark:hover:bg-blue-900/30 inline-flex transition-colors" title="Imprimir Recibo do Pedido"><i data-lucide="printer" class="w-4 h-4" aria-hidden="true"></i></a>
            {# 5. EXCLUIR #}
            <form action="{{ url_for('excluir_venda', id=pedido.primeira_venda_id) }}" method="POST" class="inline flex-shrink-0 form-excluir-pedido" data-cliente="{{ pedido.cliente_nome }}" data-nf="{{ pedido.nf }}" data-data="{{ pedido.data_venda.strftime('%d/%m/%Y') }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                <button type="submit" class="p-1.5 rounded text-red-600 dark:text-red-400 hover:text-red-800 dark:hover:text-red-300 hover:bg-red-50 dark:hover:bg-red-900/30 inline-flex transition-colors" title="Excluir Pedido Completo"><i data-lucide="trash-2" class="w-4 h-4" aria-hidden="true"></i></button>
            </form>
        </div>
    </td>
</tr>
<!-- Linha de Detalhes (Oculta por padrão) -->
<tr class="pedido-detalhes hidden {{ zebra_class }}" data-pedido-id="{{ pedido_unique_id }}">
    <td colspan="14" class="px-0 py-0">
        <div class="{{ zebra_bg_class }} border-l-4 border-emerald-300 dark:border-emerald-600 px-6 py-4">
            <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                <thead class="bg-gray-100 dark:bg-gray-900/50">
                    <tr>
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Produto</th>
                        <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Qtd</th>
                        <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Preço Unit.</th>
                        <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Total</th>
                        <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Lucro</th>
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase w-24">Ações</th>
                    </tr>
                </thead>
                <tbody class="{{ zebra_bg_class }} divide-y divide-gray-200 dark:divide-gray-700">
                    {% for venda in pedido.vendas %}
                    <tr class="hover:bg-emerald-100/50 dark:hover:bg-emerald-900/30 transition">
                        <td class="px-4 py-3 text-sm text-gray-900 dark:text-gray-100">{{ venda.produto.nome_produto if venda.produto else 'Produto Excluído' }}</td>
                        <td class="px-4 py-3 text-sm text-gray-900 dark:text-gray-100 text-right">{{ venda.quantidade_venda }}</td>
                        <td class="px-4 py-3 text-sm text-gray-900 dark:text-gray-100 text-right">{{ venda.preco_venda|formato_moeda }}</td>
                        <td class="px-4 py-3 text-sm font-medium text-gray-900 dark:text-gray-100 text-right">{{ venda.calcular_total()|formato_moeda }}</td>
                        <td class="px-4 py-3 text-sm font-medium text-right {% if venda.calcular_lucro() >= 0 %}text-emerald-600 dark:text-emerald-400{% else %}text-red-600 dark:text-red-400{% endif %}">{{ venda.calcular_lucro()|formato_moeda }}</td>
                        <td class="px-4 py-3 text-sm font-medium">
                            <button type="button" class="btn-editar-venda text-emerald-600 dark:text-emerald-400 hover:text-emerald-800 dark:hover:text-emerald-300 inline-flex bg-transparent border-none p-0 cursor-pointer" title="Editar"
                                data-id="{{ venda.id }}"
                                data-cliente-id="{{ venda.cliente_id }}"
                                data-produto-id="{{ venda.produto_id }}"
                                data-qtd="{{ venda.quantidade_venda }}"
                                data-preco="{{ venda.preco_venda }}"
                                data-nf="{{ venda.nf or '' }}"
                                data-data="{{ venda.data_venda.strftime('%Y-%m-%d') }}"
                                data-empresa="{{ venda.empresa_faturadora or '' }}"
                                data-situacao="{{ venda.situacao or 'PENDENTE' }}"
                                data-forma-pagamento="{{ venda.forma_pagamento or '' }}">
                            <i data-lucide="pencil" class="w-4 h-4"></i>
                        </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            <div class="mt-3 flex items-center gap-2">
                <button type="button" onclick="abrirModalAddItem('{{ pedido.primeira_venda_id }}')" class="text-xs bg-emerald-600 hover:bg-emerald-700 text-white py-1 px-3 rounded flex items-center gap-1">
                    <i data-lucide="plus" class="w-3.5 h-3.5"></i> Adicionar Produto
                </button>
            </div>
        </div>
    </td>
</tr>
{% endfor %}
{% endif %}
