{% extends "base.html" %}

{% block title %}Importar Produtos - Menino do Alho{% endblock %}

{% block content %}
<div class="mb-6">
    <h2 class="text-3xl font-bold text-emerald-700 dark:text-emerald-400 mb-2">Importar Produtos</h2>
    <p class="text-gray-600 dark:text-gray-400">Faça upload de um arquivo Excel (.xlsx) ou CSV (.csv)</p>
</div>

{% if erros_detalhados is defined and erros_detalhados %}
<div class="mb-6 bg-red-50 dark:bg-red-900/20 border-2 border-red-300 dark:border-red-800 rounded-lg p-5 shadow-sm" id="import-feedback-box">
    <div class="flex items-start">
        <div class="flex-shrink-0">
            <i class="fas fa-exclamation-triangle text-red-600 dark:text-red-400 text-2xl"></i>
        </div>
        <div class="ml-4 flex-1">
            <h3 class="text-lg font-bold text-red-800 dark:text-red-300 mb-2">Ops! Encontramos alguns probleminhas</h3>
            {% if sucesso is defined and sucesso > 0 %}
            <p class="text-red-700 dark:text-red-400 mb-3">Importação parcial: <strong>{{ sucesso }}</strong> novo(s) importado(s).{% if ignorados|default(0) > 0 %} <strong>{{ ignorados }}</strong> ignorado(s) por já existirem.{% endif %} <strong>{{ erros }}</strong> erro(s). Corrija os itens abaixo e importe novamente.</p>
            {% else %}
            <p class="text-red-700 dark:text-red-400 mb-3"><strong>{{ erros }}</strong> erro(s) encontrado(s).{% if ignorados|default(0) > 0 %} <strong>{{ ignorados }}</strong> ignorado(s) por já existirem.{% endif %} Confira as mensagens abaixo, ajuste sua planilha e importe novamente.</p>
            {% endif %}
            <ul class="space-y-2 max-h-64 overflow-y-auto pr-2">
                {% for msg in erros_detalhados %}
                <li class="text-sm text-red-800 dark:text-red-300 flex items-start"><span class="text-red-500 mr-2">•</span> {{ msg }}</li>
                {% endfor %}
            </ul>
        </div>
    </div>
</div>
{% endif %}

<div class="bg-white dark:bg-gray-800 rounded-lg shadow-md dark:shadow-none border border-transparent dark:border-gray-700 p-6 max-w-2xl">
    <form method="POST" enctype="multipart/form-data">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
        <div class="mb-4">
            <label for="arquivo" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                Selecione o arquivo <span class="text-red-500">*</span>
            </label>
            <input type="file" id="arquivo" name="arquivo" 
                   accept=".xlsx,.xls,.csv" 
                   required
                   class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-200 focus:ring-2 focus:ring-emerald-500 focus:border-transparent file:mr-4 file:py-1 file:px-3 file:rounded file:border-0 file:text-sm file:font-medium file:bg-emerald-50 file:text-emerald-700 dark:file:bg-emerald-900/30 dark:file:text-emerald-400 hover:file:bg-emerald-100 dark:hover:file:bg-emerald-800/40">
            <p class="mt-2 text-sm text-gray-500 dark:text-gray-400">
                Formatos aceitos: .xlsx, .xls, .csv
            </p>
        </div>

        <div class="mb-6 bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-4">
            <h3 class="font-semibold text-blue-900 dark:text-blue-400 mb-2">
                <i class="fas fa-info-circle mr-2"></i>Formato esperado:
            </h3>
            <ul class="text-sm text-blue-800 dark:text-blue-300 space-y-1">
                <li>• <strong>nome_produto</strong> (Gerado automaticamente pelo sistema)</li>
                <li>• <strong>preco_custo</strong> ou <strong>preco</strong> <span class="text-red-500">*</span> (obrigatório): Preço de custo</li>
                <li>• <strong>quantidade</strong> ou <strong>qtd</strong> <span class="text-red-500">*</span> (obrigatório): Quantidade a adicionar ao estoque</li>
                <li>• <strong>data_chegada</strong> ou <strong>data</strong> (opcional): Data de chegada (padrão: hoje)</li>
                <li>• <strong>tipo</strong> <span class="text-red-500">*</span> (obrigatório): ALHO, SACOLA ou CAFE</li>
                <li>• <strong>fornecedor</strong> <span class="text-red-500">*</span> (obrigatório): DESTAK ou PATY</li>
                <li>• <strong>nacionalidade</strong> <span class="text-red-500">*</span> (obrigatório): ARGENTINO, NACIONAL ou CHINES — <em>ou N/A para SACOLA</em></li>
                <li>• <strong>tamanho</strong> <span class="text-red-500">*</span> (obrigatório): 4, 5, 6, 7, 8, 9 ou 10 — <em>ou P, M, G para SACOLA</em></li>
                <li>• <strong>marca</strong> <span class="text-red-500">*</span> (obrigatório): Ex: IMPORFOZ — <em>ou SOPACK para SACOLA (padrão)</em></li>
                <li>• <strong>caminhoneiro</strong> <span class="text-red-500">*</span> (obrigatório): Nome do caminhoneiro</li>
            </ul>
            <p class="mt-3 text-sm text-blue-900 dark:text-blue-300 font-semibold">
                <i class="fas fa-exclamation-triangle mr-2"></i>
                Importante: Se o produto já existir (mesmo nome gerado), a quantidade será SOMADA ao estoque atual.
            </p>
        </div>

        <!-- Pré-visualização dos Dados -->
        <div id="preview-container" class="mb-6 hidden">
            <h3 class="text-lg font-semibold text-emerald-700 dark:text-emerald-400 mb-3">
                <i class="fas fa-eye mr-2"></i>Pré-visualização dos Dados
            </h3>
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md dark:shadow-none overflow-hidden border border-gray-200 dark:border-gray-700">
                <div class="overflow-x-auto">
                    <table id="preview-table" class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                        <thead class="bg-gray-50 dark:bg-gray-900/50">
                            <tr id="preview-header"></tr>
                        </thead>
                        <tbody id="preview-body" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700"></tbody>
                    </table>
                </div>
                <div class="px-4 py-2 bg-gray-50 dark:bg-gray-900/50 border-t border-gray-200 dark:border-gray-700">
                    <p class="text-xs text-gray-600 dark:text-gray-400">
                        <i class="fas fa-info-circle mr-1"></i>
                        Mostrando as primeiras <span id="preview-row-count">5</span> linhas do arquivo
                    </p>
                </div>
            </div>
        </div>

        <div class="flex gap-4">
            <button type="submit" class="px-4 py-2 bg-emerald-600 hover:bg-emerald-700 text-white font-medium rounded-md transition-colors flex items-center">
                <i data-lucide="upload" class="w-4 h-4 mr-2"></i>Importar
            </button>
            <a href="{{ url_for('listar_produtos') }}" class="px-4 py-2 bg-gray-300 dark:bg-gray-700 text-gray-700 dark:text-gray-200 font-medium rounded-md hover:bg-gray-400 dark:hover:bg-gray-600 transition-colors flex items-center">
                <i data-lucide="x" class="w-4 h-4 mr-2"></i>Cancelar
            </a>
        </div>
    </form>
</div>

<!-- SheetJS Library -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const fileInput = document.getElementById('arquivo');
    const previewContainer = document.getElementById('preview-container');
    const previewTable = document.getElementById('preview-table');
    const previewHeader = document.getElementById('preview-header');
    const previewBody = document.getElementById('preview-body');
    const previewRowCount = document.getElementById('preview-row-count');
    
    const columnOrder = [
        'produto', 'nome_produto', 'nome',
        'preco_custo', 'preco', 'preço',
        'quantidade', 'qtd', 'quantidade_venda',
        'data_chegada', 'data', 'data_entrada',
        'tipo',
        'fornecedor',
        'nacionalidade',
        'tamanho',
        'marca',
        'caminhoneiro'
    ];
    
    const columnDisplayNames = {
        'produto': 'PRODUTO',
        'nome_produto': 'PRODUTO',
        'nome': 'PRODUTO',
        'preco_custo': 'PREÇO',
        'preco': 'PREÇO',
        'preço': 'PREÇO',
        'quantidade': 'QUANTIDADE',
        'qtd': 'QUANTIDADE',
        'quantidade_venda': 'QUANTIDADE',
        'data_chegada': 'DATA',
        'data': 'DATA',
        'data_entrada': 'DATA',
        'tipo': 'TIPO',
        'fornecedor': 'FORNECEDOR',
        'nacionalidade': 'NACIONALIDADE',
        'tamanho': 'TAMANHO',
        'marca': 'MARCA',
        'caminhoneiro': 'CAMINHONEIRO'
    };
    
    function processAndDisplayData(jsonData) {
        if (jsonData.length === 0) {
            previewContainer.classList.add('hidden');
            return;
        }
        
        const headers = jsonData[0].map(h => 
            String(h || '').trim().toLowerCase().replace(/\s+/g, '_')
        );
        
        const columnIndices = {};
        headers.forEach((header, index) => {
            columnIndices[header] = index;
        });
        
        const foundColumns = [];
        columnOrder.forEach(colName => {
            if (columnIndices.hasOwnProperty(colName) && !foundColumns.includes(colName)) {
                foundColumns.push(colName);
            }
        });
        
        headers.forEach((header) => {
            if (!foundColumns.includes(header)) {
                foundColumns.push(header);
            }
        });
        
        previewHeader.innerHTML = '';
        foundColumns.forEach(colName => {
            const th = document.createElement('th');
            const isProduto = colName === 'produto' || colName === 'nome_produto' || colName === 'nome';
            th.className = 'px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider' + 
                          (isProduto ? ' min-w-[300px]' : '');
            th.textContent = columnDisplayNames[colName] || colName;
            previewHeader.appendChild(th);
        });
        
        previewBody.innerHTML = '';
        const maxRows = Math.min(5, jsonData.length - 1);
        previewRowCount.textContent = maxRows;
        
        for (let i = 1; i <= maxRows && i < jsonData.length; i++) {
            const row = jsonData[i];
            const tr = document.createElement('tr');
            tr.className = 'hover:bg-gray-50 dark:hover:bg-gray-700/50';
            
            foundColumns.forEach(colName => {
                const td = document.createElement('td');
                const isProduto = colName === 'produto' || colName === 'nome_produto' || colName === 'nome';
                td.className = 'px-6 py-4 text-sm text-gray-900 dark:text-gray-100' + 
                              (isProduto ? ' min-w-[300px] max-w-[400px] break-words' : ' whitespace-nowrap');
                
                const colIndex = columnIndices[colName];
                const cellValue = colIndex !== undefined && row[colIndex] !== undefined 
                    ? String(row[colIndex]) 
                    : '';
                
                td.textContent = cellValue || '-';
                tr.appendChild(td);
            });
            
            previewBody.appendChild(tr);
        }
        
        previewContainer.classList.remove('hidden');
    }
    
    fileInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        
        if (!file) {
            previewContainer.classList.add('hidden');
            return;
        }
        
        const reader = new FileReader();
        
        if (file.name.endsWith('.csv')) {
            reader.onload = function(e) {
                try {
                    const text = e.target.result;
                    const lines = text.split('\n').filter(line => line.trim());
                    
                    if (lines.length === 0) {
                        previewContainer.classList.add('hidden');
                        return;
                    }
                    
                    const parseCSVLine = (line) => {
                        const result = [];
                        let current = '';
                        let inQuotes = false;
                        
                        for (let i = 0; i < line.length; i++) {
                            const char = line[i];
                            
                            if (char === '"') {
                                inQuotes = !inQuotes;
                            } else if ((char === ',' || char === ';') && !inQuotes) {
                                result.push(current.trim());
                                current = '';
                            } else {
                                current += char;
                            }
                        }
                        result.push(current.trim());
                        return result;
                    };
                    
                    const jsonData = lines.map(line => parseCSVLine(line));
                    processAndDisplayData(jsonData);
                    
                } catch (error) {
                    console.error('Erro ao ler CSV:', error);
                    previewContainer.classList.add('hidden');
                    alert('Erro ao ler o arquivo CSV. Verifique se o formato está correto.');
                }
            };
            reader.readAsText(file);
        } else {
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    processAndDisplayData(jsonData);
                    
                } catch (error) {
                    console.error('Erro ao ler arquivo:', error);
                    previewContainer.classList.add('hidden');
                    alert('Erro ao ler o arquivo. Verifique se o formato está correto.');
                }
            };
            reader.readAsArrayBuffer(file);
        }
    });
    
    if (typeof lucide !== 'undefined') {
        lucide.createIcons();
    }
});
</script>
{% endblock %}
