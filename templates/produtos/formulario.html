{% extends "base.html" %}

{% block title %}{% if produto %}Editar{% else %}Nova Entrada{% endif %} de Produto - Menino do Alho{% endblock %}

{% block content %}
<div class="mb-6">
    <h2 class="text-3xl font-bold text-verde-floresta mb-2">
        {% if produto %}Editar Produto{% else %}Nova Entrada de Produto{% endif %}
    </h2>
    <p class="text-gray-600">Preencha os dados do produto</p>
</div>

<div class="bg-white rounded-lg shadow-md p-6 max-w-3xl">
    {% if produto %}
    <div class="mb-4 bg-blue-50 border border-blue-200 rounded-lg p-4">
        <p class="text-sm text-blue-800">
            <i class="fas fa-info-circle mr-2"></i>
            <strong>Produto:</strong> {{ produto.nome_produto }}<br>
            <strong>Estoque Atual:</strong> {{ produto.estoque_atual }} unidades
        </p>
    </div>
    {% endif %}

    <form method="POST" action="{% if produto %}{{ url_for('editar_produto', id=produto.id) }}{% else %}{{ url_for('novo_produto') }}{% endif %}">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <!-- 1. Produto (Nome gerado) - Exibido acima se editando -->
            
            <!-- 2. Preço (Preço de Custo) -->
            <div class="mb-4 md:col-span-2">
                <label for="preco_custo" class="block text-sm font-medium text-gray-700 mb-2">
                    Preço <span class="text-red-500">*</span>
                </label>
                <input type="number" id="preco_custo" name="preco_custo" 
                       value="{{ produto.preco_custo if produto else '' }}" 
                       step="0.01" min="0" required inputmode="decimal" pattern="[0-9]*"
                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-verde-floresta focus:border-transparent">
            </div>

            <!-- 3. Quantidade (Estoque Atual) -->
            <div class="mb-4">
                <label for="quantidade_entrada" class="block text-sm font-medium text-gray-700 mb-2">
                    {% if produto %}Quantidade Adicional{% else %}Quantidade{% endif %} <span class="text-red-500">*</span>
                </label>
                <input type="number" id="quantidade_entrada" name="quantidade_entrada" 
                       value="{% if produto %}0{% else %}1{% endif %}" 
                       min="0" required inputmode="decimal" pattern="[0-9]*"
                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-verde-floresta focus:border-transparent">
                {% if produto %}
                <p class="mt-1 text-sm text-gray-500">Estoque atual: <strong>{{ produto.estoque_atual }}</strong></p>
                {% endif %}
            </div>

            <!-- 4. Data Chegada -->
            <div class="mb-4">
                <label for="data_chegada" class="block text-sm font-medium text-gray-700 mb-2">
                    Data Chegada
                </label>
                <input type="date" id="data_chegada" name="data_chegada" 
                       value="{% if produto %}{{ produto.data_chegada.strftime('%Y-%m-%d') }}{% endif %}"
                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-verde-floresta focus:border-transparent">
            </div>

            <!-- 5. Tipo -->
            <div class="mb-4">
                <label for="tipo" class="block text-sm font-medium text-gray-700 mb-2">
                    Tipo <span class="text-red-500">*</span>
                </label>
                <select id="tipo" name="tipo" required
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-verde-floresta focus:border-transparent">
                    <option value="">Selecione...</option>
                    <option value="ALHO" {% if produto and produto.tipo == 'ALHO' %}selected{% endif %}>ALHO</option>
                    <option value="SACOLA" {% if produto and produto.tipo == 'SACOLA' %}selected{% endif %}>SACOLA</option>
                    <option value="CAFE" {% if produto and produto.tipo == 'CAFE' %}selected{% endif %}>CAFE</option>
                </select>
            </div>

            <!-- 6. Fornecedor -->
            <div class="mb-4">
                <label for="fornecedor" class="block text-sm font-medium text-gray-700 mb-2">
                    Fornecedor <span class="text-red-500">*</span>
                </label>
                <select id="fornecedor" name="fornecedor" required
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-verde-floresta focus:border-transparent">
                    <option value="">Selecione...</option>
                    <option value="DESTAK" {% if produto and produto.fornecedor == 'DESTAK' %}selected{% endif %}>DESTAK</option>
                    <option value="PATY" {% if produto and produto.fornecedor == 'PATY' %}selected{% endif %}>PATY</option>
                    <option value="SERVE BEM" {% if produto and produto.fornecedor == 'SERVE BEM' %}selected{% endif %}>SERVE BEM</option>
                </select>
            </div>

            <!-- 7. Nacionalidade (N/A quando Tipo = SACOLA) -->
            <div class="mb-4" id="nacionalidade-wrap">
                <label for="nacionalidade" class="block text-sm font-medium text-gray-700 mb-2">
                    Nacionalidade <span class="text-red-500" id="nacionalidade-asterisco">*</span>
                </label>
                <input type="hidden" id="nacionalidade_hidden" value="N/A">
                <select id="nacionalidade" name="nacionalidade" required
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-verde-floresta focus:border-transparent">
                    <option value="">Selecione...</option>
                    <option value="ARGENTINO" {% if produto and produto.nacionalidade == 'ARGENTINO' %}selected{% endif %}>Argentino</option>
                    <option value="NACIONAL" {% if produto and produto.nacionalidade == 'NACIONAL' %}selected{% endif %}>Nacional</option>
                    <option value="CHINES" {% if produto and produto.nacionalidade == 'CHINES' %}selected{% endif %}>Chinês</option>
                    <option value="ESPANHOL" {% if produto and produto.nacionalidade == 'ESPANHOL' %}selected{% endif %}>Espanhol</option>
                    <option value="PERUANO" {% if produto and produto.nacionalidade == 'PERUANO' %}selected{% endif %}>Peruano</option>
                    <option value="NA" {% if produto and produto.nacionalidade == 'NA' or produto.nacionalidade == 'N/A' %}selected{% endif %}>N/A (Não se aplica)</option>
                </select>
                <p class="mt-1 text-sm text-gray-500 hidden" id="nacionalidade-na-msg">N/A para SACOLA</p>
            </div>

            <!-- 8. Tamanho (4–10 ou P/M/G quando SACOLA) -->
            <div class="mb-4">
                <label for="tamanho" class="block text-sm font-medium text-gray-700 mb-2">
                    Tamanho <span class="text-red-500">*</span>
                </label>
                <select id="tamanho" name="tamanho" required
                        data-initial="{{ produto.tamanho if produto else '' }}"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-verde-floresta focus:border-transparent">
                    <option value="">Selecione...</option>
                    {% for tam in ['3', '4', '5', '6', '7', '8', '9', '10'] %}
                    <option value="{{ tam }}" {% if produto and produto.tamanho == tam %}selected{% endif %}>{{ tam }}</option>
                    {% endfor %}
                    <option value="NA" {% if produto and produto.tamanho == 'NA' %}selected{% endif %}>N/A (Não se aplica)</option>
                </select>
            </div>

            <!-- 9. Marca (SOPACK quando Tipo = SACOLA) -->
            <div class="mb-4" id="marca-wrap">
                <label for="marca" class="block text-sm font-medium text-gray-700 mb-2">
                    Marca <span class="text-red-500" id="marca-asterisco">*</span>
                </label>
                <input type="hidden" id="marca_hidden" value="SOPACK">
                <input type="text" id="marca" name="marca" 
                       value="{{ produto.marca if produto else '' }}" 
                       required autocapitalize="words" autocomplete="off" spellcheck="false"
                       placeholder="Ex: IMPORFOZ"
                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-verde-floresta focus:border-transparent">
            </div>

            <!-- 10. Caminhoneiro -->
            <div class="mb-4">
                <label for="caminhoneiro" class="block text-sm font-medium text-gray-700 mb-2">
                    Caminhoneiro <span class="text-red-500">*</span>
                </label>
                <input type="text" id="caminhoneiro" name="caminhoneiro" 
                       value="{{ produto.caminhoneiro if produto else '' }}"
                       required autocapitalize="words" autocomplete="off" spellcheck="false"
                       placeholder="Ex: ALEXANDRE"
                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-verde-floresta focus:border-transparent">
            </div>
        </div>

        <div class="flex gap-4 mt-6">
            <button type="submit" class="bg-verde-floresta text-white px-6 py-2 rounded-lg hover:bg-green-800 transition">
                <i class="fas fa-save mr-2"></i>Salvar
            </button>
            <a href="{{ url_for('listar_produtos') }}" class="bg-gray-300 text-gray-700 px-6 py-2 rounded-lg hover:bg-gray-400 transition">
                <i class="fas fa-times mr-2"></i>Cancelar
            </a>
        </div>
    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const dataChegadaInput = document.getElementById('data_chegada');
    if (!dataChegadaInput.value) {
        const today = new Date().toISOString().split('T')[0];
        dataChegadaInput.value = today;
    }

    const tipoSelect = document.getElementById('tipo');
    const fornecedorSelect = document.getElementById('fornecedor');
    const nacionalidadeSelect = document.getElementById('nacionalidade');
    const nacionalidadeHidden = document.getElementById('nacionalidade_hidden');
    const nacionalidadeAsterisco = document.getElementById('nacionalidade-asterisco');
    const nacionalidadeNaMsg = document.getElementById('nacionalidade-na-msg');
    const tamanhoSelect = document.getElementById('tamanho');
    const marcaInput = document.getElementById('marca');
    const marcaHidden = document.getElementById('marca_hidden');
    const marcaAsterisco = document.getElementById('marca-asterisco');

    const OPCOES_NUMERICAS = ['3', '4', '5', '6', '7', '8', '9', '10'];
    const OPCOES_SACOLA = ['P', 'M', 'G'];

    function isSacola() {
        return tipoSelect && tipoSelect.value === 'SACOLA';
    }

    function aplicarModoSacola() {
        var initialTamanho = (tamanhoSelect && tamanhoSelect.getAttribute('data-initial')) ? tamanhoSelect.getAttribute('data-initial') : '';
        var opts = [];
        var keepVal = '';

        if (!isSacola()) {
            nacionalidadeSelect.disabled = false;
            nacionalidadeHidden.removeAttribute('name');
            nacionalidadeSelect.setAttribute('name', 'nacionalidade');
            nacionalidadeSelect.required = true;
            if (nacionalidadeAsterisco) nacionalidadeAsterisco.classList.remove('hidden');
            if (nacionalidadeNaMsg) nacionalidadeNaMsg.classList.add('hidden');
            // Limpar valores antigos (compatibilidade com "N/A" e "NA")
            if (nacionalidadeSelect.value === 'N/A' || nacionalidadeSelect.value === 'NA') {
                nacionalidadeSelect.value = '';
            }

            opts = OPCOES_NUMERICAS;
            keepVal = OPCOES_NUMERICAS.indexOf(initialTamanho) >= 0 ? initialTamanho : '';

            marcaInput.disabled = false;
            marcaHidden.removeAttribute('name');
            marcaInput.setAttribute('name', 'marca');
            marcaInput.required = true;
            if (marcaInput.dataset.initial) marcaInput.value = marcaInput.dataset.initial;
            else if (!isSacola()) marcaInput.value = '';
            marcaInput.removeAttribute('data-initial');
            if (marcaAsterisco) marcaAsterisco.classList.remove('hidden');
        } else {
            nacionalidadeSelect.value = 'N/A';
            nacionalidadeSelect.disabled = true;
            nacionalidadeSelect.removeAttribute('name');
            nacionalidadeHidden.setAttribute('name', 'nacionalidade');
            nacionalidadeHidden.value = 'N/A';
            nacionalidadeSelect.required = false;
            if (nacionalidadeAsterisco) nacionalidadeAsterisco.classList.add('hidden');
            if (nacionalidadeNaMsg) nacionalidadeNaMsg.classList.remove('hidden');

            opts = OPCOES_SACOLA;
            keepVal = OPCOES_SACOLA.indexOf(initialTamanho) >= 0 ? initialTamanho : '';

            marcaInput.value = 'SOPACK';
            marcaInput.disabled = true;
            marcaInput.removeAttribute('name');
            marcaHidden.setAttribute('name', 'marca');
            marcaHidden.value = 'SOPACK';
            marcaInput.required = false;
            if (marcaAsterisco) marcaAsterisco.classList.add('hidden');
        }

        // Construir HTML do select de tamanho
        var tamanhoHTML = '<option value="">Selecione...</option>';
        
        // Adicionar opção N/A apenas quando não for SACOLA
        if (!isSacola()) {
            tamanhoHTML += '<option value="NA"' + (keepVal === 'NA' ? ' selected' : '') + '>N/A (Não se aplica)</option>';
        }
        
        // Adicionar opções numéricas ou de sacola
        tamanhoHTML += opts.map(function(t) { 
            return '<option value="' + t + '"' + (t === keepVal ? ' selected' : '') + '>' + t + '</option>'; 
        }).join('');
        
        tamanhoSelect.innerHTML = tamanhoHTML;
        if (keepVal) tamanhoSelect.value = keepVal;
        tamanhoSelect.removeAttribute('data-initial');
    }

    if (tipoSelect) {
        var initTamanho = tamanhoSelect.getAttribute('data-initial') || '';
        var initMarca = marcaInput.value || '';
        if (initMarca) marcaInput.setAttribute('data-initial', initMarca);

        aplicarModoSacola();

        tipoSelect.addEventListener('change', function() {
            tamanhoSelect.setAttribute('data-initial', tamanhoSelect.value || '');
            if (tipoSelect.value === 'SACOLA' && marcaInput.getAttribute('name') === 'marca')
                marcaInput.setAttribute('data-initial', marcaInput.value || '');
            
            // Aplicar lógica de SACOLA primeiro (pode sobrescrever tamanho)
            aplicarModoSacola();
            
            // Automação: Preencher campos automaticamente para CAFE (executar DEPOIS de aplicarModoSacola)
            var tipo = tipoSelect.value;
            
            // Verifica se é CAFE (ignorando maiúsculas/minúsculas)
            if (tipo && tipo.toUpperCase().includes('CAFE')) {
                // Como agora as options existem no HTML, podemos selecionar direto:
                fornecedorSelect.value = 'SERVE BEM';
                nacionalidadeSelect.value = 'NA';
                tamanhoSelect.value = 'NA';
                
                // Destacar os campos para mostrar que foram preenchidos automaticamente
                fornecedorSelect.classList.add('bg-emerald-50', 'border-emerald-300');
                nacionalidadeSelect.classList.add('bg-emerald-50', 'border-emerald-300');
                tamanhoSelect.classList.add('bg-emerald-50', 'border-emerald-300');
                setTimeout(function() {
                    fornecedorSelect.classList.remove('bg-emerald-50', 'border-emerald-300');
                    nacionalidadeSelect.classList.remove('bg-emerald-50', 'border-emerald-300');
                    tamanhoSelect.classList.remove('bg-emerald-50', 'border-emerald-300');
                }, 2000);
            } else if (tipo === 'ALHO' || tipo === '') {
                // Se mudar de volta para ALHO, limpa para evitar erros de cadastro
                // Mas só limpa se o valor atual for o automático (opcional)
                var isEditing = {{ 'true' if produto else 'false' }};
                
                if (!isEditing) {
                    if (fornecedorSelect.value === 'SERVE BEM') fornecedorSelect.value = '';
                    if (nacionalidadeSelect && nacionalidadeSelect.value === 'NA' && tipo !== 'SACOLA') nacionalidadeSelect.value = '';
                    if (tamanhoSelect && tamanhoSelect.value === 'NA') tamanhoSelect.value = '';
                }
            }
            // Se for SACOLA, a função aplicarModoSacola já cuidou dos campos
        });
    }
});
</script>
{% endblock %}
