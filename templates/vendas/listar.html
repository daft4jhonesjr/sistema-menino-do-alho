{% extends "base.html" %}

{% block title %}Vendas - Menino do Alho{% endblock %}

{% block head_extras %}
<link href="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/css/tom-select.css" rel="stylesheet">
<style>
    /* Simetria: altura, borda e arredondamento iguais em todos os campos */
    .venda-input-group input,
    .venda-input-group select,
    .venda-input-group .ts-wrapper .ts-control {
        height: 42px !important;
        min-height: 42px !important;
        border-radius: 8px !important;
        font-size: 0.875rem !important;
        padding: 0 0.75rem !important;
        box-sizing: border-box !important;
        border: 1px solid #e5e7eb !important;
        line-height: 1.5 !important;
    }
    .venda-input-group .ts-wrapper .ts-control {
        display: flex !important;
        align-items: center !important;
    }
    .venda-input-group input:focus,
    .venda-input-group select:focus,
    .venda-input-group .ts-wrapper.focus .ts-control,
    .venda-input-group .ts-wrapper .ts-control:focus-within {
        border-color: #047857 !important;
        box-shadow: 0 0 0 2px rgba(4, 120, 87, 0.5) !important;
        outline: none !important;
    }
    .venda-input-group #btn-adicionar-carrinho {
        height: 42px !important;
        min-height: 42px !important;
        border-radius: 8px !important;
        font-size: 0.875rem !important;
        padding: 0 0.75rem !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        white-space: nowrap !important;
    }
    /* TomSelect (Cliente): remove borda do wrapper, mant√©m apenas no ts-control */
    .venda-input-group .ts-wrapper {
        min-height: 42px !important;
        border: none !important;
        box-shadow: none !important;
        background: transparent !important;
    }
    .venda-input-group .ts-wrapper .ts-control {
        border: 1px solid #e5e7eb !important;
        border-radius: 8px !important;
        background-color: #fff !important;
    }
    .dark .venda-input-group .ts-wrapper .ts-control {
        border-color: #4b5563 !important;
        background-color: #374151 !important;
        color: #f3f4f6 !important;
    }
    .dark .venda-input-group .ts-wrapper .ts-control input {
        background-color: transparent !important;
        color: #f3f4f6 !important;
    }
    .dark .venda-input-group .ts-wrapper .ts-control input::placeholder {
        color: #9ca3af !important;
    }
    .venda-input-group .ts-wrapper.focus .ts-control,
    .venda-input-group .ts-wrapper .ts-control:focus-within {
        border-color: #047857 !important;
        box-shadow: 0 0 0 2px rgba(4, 120, 87, 0.5) !important;
        outline: none !important;
    }
    .venda-input-group .produto-select { appearance: none !important; background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e") !important; background-position: right 0.75rem center !important; background-repeat: no-repeat !important; background-size: 1.25rem 1.25rem !important; padding-right: 2.5rem !important; }
    .venda-input-group .produto-select option[value=""] { color: #9ca3af; }
    .dark .venda-input-group .produto-select {
        background-color: #374151 !important;
        color: #f3f4f6 !important;
        border-color: #4b5563 !important;
    }
    .dark .venda-input-group .produto-select option {
        background-color: #374151;
        color: #f3f4f6;
    }
    .vendas-cliente-dropdown { border-radius: 0.375rem !important; border-color: #e5e7eb !important; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1) !important; max-height: 280px !important; }
    .vendas-cliente-dropdown .option { padding: 0.5rem 0.75rem; }
    .vendas-cliente-dropdown .option.active { background-color: #ecfdf5; color: #047857; }
    .vendas-cliente-dropdown .no-results { padding: 0.75rem 1rem; color: #6b7280; font-size: 0.875rem; }
    /* TomSelect dropdown - modo escuro */
    .dark .vendas-cliente-dropdown,
    .dark .ts-dropdown.vendas-cliente-dropdown {
        background-color: #1f2937 !important;
        border-color: #374151 !important;
        color: #f3f4f6 !important;
    }
    .dark .vendas-cliente-dropdown .option {
        color: #f3f4f6 !important;
    }
    .dark .vendas-cliente-dropdown .option:hover,
    .dark .vendas-cliente-dropdown .option.active {
        background-color: #374151 !important;
        color: #f3f4f6 !important;
    }
    .dark .vendas-cliente-dropdown .no-results {
        color: #9ca3af !important;
    }
    .pedido-chevron { transition: transform 0.2s ease-in-out; }
    .pedido-detalhes { transition: opacity 0.2s ease-in-out; }
    .pedido-resumo { user-select: none; }
    .badge-situacao-toggle:hover { opacity: 0.9; }
    .badge-status-transition {
        animation: badge-status-pulse 0.4s ease-out;
    }
    @keyframes badge-status-pulse {
        0% { opacity: 0.5; transform: scale(0.96); }
        100% { opacity: 1; transform: scale(1); }
    }
    .preco-sugerido { color: #9ca3af; }
    .alerta-vencido-pulse {
        animation: alerta-vencido-pulse 1.2s ease-in-out infinite;
    }
    @keyframes alerta-vencido-pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }
    .linha-vencida-abatimento { background-color: #fef2f2 !important; }
    .linha-vencida-abatimento:hover { background-color: #fee2e2 !important; }
    .dark .linha-vencida-abatimento { background-color: rgba(127, 29, 29, 0.3) !important; }
    .dark .linha-vencida-abatimento:hover { background-color: rgba(153, 27, 27, 0.4) !important; }
    /* Feedback visual PDV: campo preenchido com sucesso */
    .campo-preenchido { border-color: #28a745 !important; background-color: #e8f5e9 !important; transition: all 0.3s ease; }
    #cliente-select-wrap .ts-wrapper.campo-preenchido .ts-control { border-color: #28a745 !important; background-color: #e8f5e9 !important; }
    .dark #cliente-select-wrap .ts-wrapper.campo-preenchido .ts-control { border-color: #059669 !important; background-color: #064e3b !important; color: #f3f4f6 !important; }
</style>
{% endblock %}

{% block content %}
<div class="mb-6 flex justify-between items-center">
    <div>
        <h2 class="text-3xl font-bold text-emerald-700 dark:text-emerald-400 mb-2">Vendas</h2>
        <p class="text-gray-600 dark:text-gray-400">Gerenciar vendas realizadas</p>
    </div>
    <div class="flex gap-3">
        {% if current_user.is_authenticated and current_user.is_admin() %}
        <a href="{{ url_for('importar_vendas') }}" class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 text-gray-700 dark:text-gray-200 px-5 py-2.5 rounded-xl shadow-sm dark:shadow-none hover:bg-emerald-50 dark:hover:bg-gray-700 hover:border-emerald-200 dark:hover:border-emerald-600 hover:text-emerald-700 dark:hover:text-emerald-400 transition flex items-center font-medium">
            <i data-lucide="upload" class="w-4 h-4 mr-2"></i>Importar Lista
        </a>
        {% endif %}
    </div>
</div>

<div id="bulk-delete-toast" class="hidden mb-4 p-4 rounded-xl border border-emerald-200 dark:border-emerald-800 bg-emerald-50 dark:bg-emerald-900/30 text-emerald-800 dark:text-emerald-200 flex items-center shadow-sm">
    <i data-lucide="check-circle" class="w-5 h-5 mr-3 flex-shrink-0"></i>
    <span id="bulk-delete-toast-msg"></span>
</div>

{% if produto_filtro or cliente_filtro %}
<div class="mb-4 bg-emerald-50 dark:bg-emerald-900/30 border border-emerald-200 dark:border-emerald-800 rounded-xl p-4 flex items-center justify-between shadow-sm">
    <div class="flex items-center">
        <i data-lucide="filter" class="w-5 h-5 text-emerald-700 dark:text-emerald-400 mr-3"></i>
        <div>
            <p class="text-sm font-semibold text-emerald-800 dark:text-emerald-200">Filtro Ativo:</p>
            <p class="text-sm text-gray-700 dark:text-gray-300 mt-1">
                Mostrando vendas para:
                {% if produto_filtro %}
                    <span class="font-bold text-emerald-700">{{ produto_filtro.nome_produto }}</span>
                {% endif %}
                {% if cliente_filtro %}
                    {% if produto_filtro %} e {% endif %}
                    <span class="font-bold text-emerald-700">{{ cliente_filtro.nome_cliente }}</span>
                {% endif %}
            </p>
        </div>
    </div>
    <a href="{{ url_for('listar_vendas') }}"
       class="bg-white dark:bg-gray-800 border border-emerald-700 dark:border-emerald-600 text-emerald-700 dark:text-emerald-400 px-4 py-2 rounded-xl hover:bg-emerald-700 hover:text-white transition flex items-center font-medium text-sm">
        <i data-lucide="x" class="w-4 h-4 mr-2"></i>Limpar Filtro
    </a>
</div>
{% endif %}

<!-- Alerta de erro (discreto, acima dos campos) -->
<div id="venda-erro" class="hidden mb-4 p-4 bg-red-50 dark:bg-red-900/30 border border-red-200 dark:border-red-800 rounded-xl text-red-800 dark:text-red-300 text-sm shadow-sm"></div>

<!-- Linha de inser√ß√£o: campos alinhados com a tabela -->
<div class="mb-4 bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 shadow-sm dark:shadow-none overflow-hidden">
        <form id="form-nova-venda-inline" action="{{ url_for('add_venda') }}" method="POST" class="p-4" novalidate>
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
        <div class="venda-input-group flex flex-col gap-5 w-full">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-5 items-start">
                <div class="md:col-span-1 flex flex-col justify-start relative w-full" id="cliente-select-wrap">
                    <label for="inline-cliente_id" class="block text-xs font-medium text-gray-600 dark:text-gray-200 mb-1">Cliente</label>
                    <select id="inline-cliente_id" name="cliente_id" required class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-emerald-500 focus:border-emerald-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-emerald-500 dark:focus:border-emerald-500 shadow-sm">
                        <option value="">Digite o nome...</option>
                        {% for c in clientes %}
                        <option value="{{ c.id }}">{{ c.nome_cliente }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="md:col-span-2 flex flex-col justify-start" id="produto-select-wrap">
                    <label for="inline-produto_id" class="block text-xs font-medium text-gray-600 dark:text-gray-200 mb-1">Produto</label>
                    <select id="inline-produto_id" name="produto_id" required class="produto-select bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-emerald-500 focus:border-emerald-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-emerald-500 dark:focus:border-emerald-500 shadow-sm appearance-none pr-8">
                        <option value="" class="text-gray-400">Selecione o produto</option>
                        {% for p in produtos %}
                        {% set nome_lower = p.nome_produto|lower %}
                        {% if 'alho' in nome_lower %}{% set emoji = 'üßÑ' %}{% elif 'cafe' in nome_lower or 'caf√©' in nome_lower %}{% set emoji = '‚òï' %}{% elif 'sacola' in nome_lower %}{% set emoji = 'üõçÔ∏è' %}{% else %}{% set emoji = 'üì¶' %}{% endif %}
                        <option value="{{ p.id }}" data-estoque="{{ p.estoque_atual }}" data-preco="{{ p.preco_custo }}">{{ emoji }} {{ p.nome_produto }} (Est.: {{ p.estoque_atual }})</option>
                        {% endfor %}
                    </select>
                    <p id="inline-estoque-info" class="mt-0.5 text-xs text-gray-500 dark:text-gray-400"></p>
                </div>
            </div>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-5">
                <div>
                    <label for="inline-nf" class="block text-xs font-medium text-gray-600 dark:text-gray-200 mb-1">NF</label>
                    <input type="text" id="inline-nf" name="nf" placeholder="00123" inputmode="numeric" pattern="[0-9]*" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-emerald-500 focus:border-emerald-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-emerald-500 dark:focus:border-emerald-500 shadow-sm">
                </div>
                <div>
                    <label for="inline-quantidade_venda" class="block text-xs font-medium text-gray-600 dark:text-gray-200 mb-1">Qtd</label>
                    <input type="number" id="inline-quantidade_venda" name="quantidade_venda" value="1" min="1" required placeholder="1" inputmode="decimal" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-emerald-500 focus:border-emerald-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-emerald-500 dark:focus:border-emerald-500 shadow-sm">
                </div>
                <div>
                    <label for="preco" class="block text-xs font-medium text-gray-600 dark:text-gray-200 mb-1">Pre√ßo</label>
                    <input type="text" id="preco" name="preco_venda" required placeholder="R$ 0,00" inputmode="decimal" class="preco-input bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-emerald-500 focus:border-emerald-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-emerald-500 dark:focus:border-emerald-500 shadow-sm" autocomplete="off">
                </div>
                <div>
                    <label for="inline-valor-total" class="block text-xs font-medium text-gray-600 dark:text-gray-200 mb-1">Total</label>
                    <input type="text" id="inline-valor-total" readonly placeholder="R$ 0,00" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:text-white shadow-sm cursor-default" tabindex="-1" title="Calculado automaticamente (Pre√ßo √ó Quantidade)">
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-5 gap-5 items-end">
                <div>
                    <label for="inline-data_venda" class="block text-xs font-medium text-gray-600 dark:text-gray-200 mb-1">Data</label>
                    <input type="date" id="inline-data_venda" name="data_venda" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-emerald-500 focus:border-emerald-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:text-white dark:focus:ring-emerald-500 dark:focus:border-emerald-500 shadow-sm">
                </div>
                <div>
                    <label for="inline-empresa_faturadora" class="block text-xs font-medium text-gray-600 dark:text-gray-200 mb-1">Empresa</label>
                    <select id="inline-empresa_faturadora" name="empresa_faturadora" required class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-emerald-500 focus:border-emerald-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:text-white dark:focus:ring-emerald-500 dark:focus:border-emerald-500 shadow-sm">
                        <option value="">--</option>
                        <option value="DESTAK">DESTAK</option>
                        <option value="PATY">PATY</option>
                        <option value="NENHUM">NENHUM</option>
                    </select>
                </div>
                <div>
                    <label for="inline-situacao" class="block text-xs font-medium text-gray-600 dark:text-gray-200 mb-1">Situa√ß√£o</label>
                    <select id="inline-situacao" name="situacao" required class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-emerald-500 focus:border-emerald-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:text-white dark:focus:ring-emerald-500 dark:focus:border-emerald-500 shadow-sm">
                        <option value="PENDENTE">‚è≥ Pendente</option>
                        <option value="PAGO">‚úÖ Pago</option>
                    </select>
                </div>
                <div>
                    <label for="inline-forma_pagamento" class="block text-xs font-medium text-gray-600 dark:text-gray-200 mb-1">Forma de Pagto</label>
                    <select id="inline-forma_pagamento" name="forma_pagamento" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-emerald-500 focus:border-emerald-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:text-white dark:focus:ring-emerald-500 dark:focus:border-emerald-500 shadow-sm">
                        <option value="">Selecione...</option>
                        <option value="BOLETO">üìÑ Boleto</option>
                        <option value="DINHEIRO">üíµ Dinheiro</option>
                        <option value="PIX">üí† Pix</option>
                        <option value="CHEQUE">‚úçÔ∏è Cheque</option>
                        <option value="TRANSFERENCIA">üè¶ Transfer√™ncia</option>
                    </select>
                </div>
                <div>
                    <button type="submit" id="btn-adicionar-carrinho" class="w-full h-[42px] flex items-center justify-center gap-2 bg-emerald-700 hover:bg-emerald-600 text-white font-medium text-sm rounded-xl shadow transition-colors whitespace-nowrap">
                        <i data-lucide="shopping-cart" class="w-4 h-4"></i>Adicionar
                    </button>
                </div>
            </div>
        </div>
    </form>
</div>

<!-- Carrinho atual (entre barra de inser√ß√£o e tabela) -->
<div id="carrinho-wrap" class="mb-4 bg-emerald-50 dark:bg-emerald-900/20 border-2 border-dashed border-emerald-200 dark:border-emerald-800 rounded-xl p-4 shadow-sm" data-processar-url="{{ url_for('processar_carrinho') }}">
    <h3 class="text-lg font-bold text-emerald-800 dark:text-emerald-300 mb-3 flex items-center">
        <i data-lucide="shopping-bag" class="w-5 h-5 mr-2"></i>üõí Carrinho Atual
    </h3>
    <div id="carrinho-vazio" class="py-6 text-center text-gray-500 dark:text-emerald-400 text-sm">Carrinho vazio. Adicione itens acima.</div>
    <div id="carrinho-tabela-wrap" class="hidden overflow-x-auto rounded-lg border border-dashed border-emerald-200 dark:border-emerald-800">
        <table class="min-w-full divide-y divide-emerald-200 dark:divide-emerald-800">
            <thead class="bg-emerald-100/60 dark:bg-emerald-900/40">
                <tr>
                    <th class="px-4 py-2 text-left text-xs font-medium text-emerald-800 dark:text-emerald-300 uppercase">Cliente</th>
                    <th class="px-4 py-2 text-left text-xs font-medium text-emerald-800 dark:text-emerald-300 uppercase">Produto</th>
                    <th class="px-4 py-2 text-left text-xs font-medium text-emerald-800 dark:text-emerald-300 uppercase">NF</th>
                    <th class="px-4 py-2 text-right text-xs font-medium text-emerald-800 dark:text-emerald-300 uppercase">Qtd</th>
                    <th class="px-4 py-2 text-right text-xs font-medium text-emerald-800 dark:text-emerald-300 uppercase">Pre√ßo</th>
                    <th class="px-4 py-2 text-right text-xs font-medium text-emerald-800 dark:text-emerald-300 uppercase">Lucro</th>
                    <th class="px-4 py-2 text-right text-xs font-medium text-emerald-800 dark:text-emerald-300 uppercase">Total</th>
                    <th class="px-4 py-2 text-left text-xs font-medium text-emerald-800 dark:text-emerald-300 uppercase">Forma Pagto</th>
                    <th class="px-4 py-2 w-12"></th>
                </tr>
            </thead>
            <tbody id="carrinho-tbody" class="bg-white dark:bg-gray-800 divide-y divide-emerald-200 dark:divide-emerald-800"></tbody>
        </table>
    </div>
    <div id="carrinho-acoes" class="hidden mt-4 flex flex-wrap items-center gap-4">
        <div id="carrinho-resumo" class="flex flex-wrap items-baseline gap-4 text-sm">
            <span class="text-gray-600 dark:text-gray-400">Total Bruto: <strong class="text-gray-900 dark:text-gray-100" id="carrinho-total-bruto">R$ 0,00</strong></span>
            <span class="text-gray-600 dark:text-gray-400">Lucro Estimado: <strong id="carrinho-lucro-estimado" class="text-emerald-600 dark:text-emerald-400">R$ 0,00</strong></span>
        </div>
        <div class="flex flex-wrap gap-3">
            <button type="button" id="btn-finalizar-carrinho" class="bg-emerald-700 text-white px-6 py-3 rounded-xl hover:bg-emerald-600 transition font-semibold flex items-center shadow-sm">
                <i data-lucide="check-circle" class="w-5 h-5 mr-2"></i>Finalizar Venda e Gerar NFs
            </button>
            <button type="button" id="btn-limpar-carrinho" class="bg-gray-500 text-white px-6 py-3 rounded-xl hover:bg-gray-600 transition font-medium flex items-center">
                <i data-lucide="trash-2" class="w-5 h-5 mr-2"></i>Limpar Carrinho
            </button>
        </div>
    </div>
</div>

<!-- An√°lise Geral de Vendas (Gr√°ficos Doughnut) -->
<div class="mt-8 mb-8">
    <h2 class="text-lg font-bold text-gray-900 dark:text-white mb-4">An√°lise Geral de Vendas</h2>
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm p-5 border border-gray-100 dark:border-gray-700">
            <h3 class="text-sm font-semibold text-gray-500 dark:text-gray-400 text-center mb-4">Por Situa√ß√£o</h3>
            <div class="relative h-48 w-full"><canvas id="chartSituacao"></canvas></div>
        </div>
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm p-5 border border-gray-100 dark:border-gray-700">
            <h3 class="text-sm font-semibold text-gray-500 dark:text-gray-400 text-center mb-4">Por Forma de Pagamento</h3>
            <div class="relative h-48 w-full"><canvas id="chartPagamento"></canvas></div>
        </div>
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm p-5 border border-gray-100 dark:border-gray-700">
            <h3 class="text-sm font-semibold text-gray-500 dark:text-gray-400 text-center mb-4">Por Empresa Faturadora</h3>
            <div class="relative h-48 w-full"><canvas id="chartEmpresa"></canvas></div>
        </div>
    </div>
</div>

<div class="mb-4 flex flex-wrap items-center gap-3">
    <span class="text-sm font-medium text-gray-700 dark:text-gray-300">Ordenar por data de venda:</span>
    {% set url_params = {} %}
    {% if request.args.get('produto_id') %}
        {% set _ = url_params.update({'produto_id': request.args.get('produto_id')}) %}
    {% endif %}
    {% if request.args.get('cliente_id') %}
        {% set _ = url_params.update({'cliente_id': request.args.get('cliente_id')}) %}
    {% endif %}
    {% if filtro_vencidos %}
        {% set _ = url_params.update({'filtro_vencidos': 1}) %}
    {% endif %}
    {% set url_params_crescente = url_params.copy() %}
    {% set _ = url_params_crescente.update({'ordem_data': 'crescente'}) %}
    {% set url_params_decrescente = url_params.copy() %}
    {% set _ = url_params_decrescente.update({'ordem_data': 'decrescente'}) %}
    <a href="{{ url_for('listar_vendas', **url_params_crescente) }}" class="px-4 py-2 rounded-xl text-sm font-medium transition {{ 'bg-emerald-700 text-white' if ordem_data == 'crescente' else 'bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 text-gray-700 dark:text-gray-200 hover:bg-emerald-50 dark:hover:bg-gray-700 hover:border-emerald-200 dark:hover:border-emerald-600' }}">
        <i data-lucide="arrow-up" class="w-4 h-4 inline-block mr-1.5 align-middle"></i>Data crescente
    </a>
    <a href="{{ url_for('listar_vendas', **url_params_decrescente) }}" class="px-4 py-2 rounded-xl text-sm font-medium transition {{ 'bg-emerald-700 text-white' if ordem_data == 'decrescente' else 'bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 text-gray-700 dark:text-gray-200 hover:bg-emerald-50 dark:hover:bg-gray-700 hover:border-emerald-200 dark:hover:border-emerald-600' }}">
        <i data-lucide="arrow-down" class="w-4 h-4 inline-block mr-1.5 align-middle"></i>Data decrescente
    </a>
    <span class="text-gray-300 dark:text-gray-600">|</span>
    {% set url_venc_cresc = url_params.copy() %}
    {% set _ = url_venc_cresc.update({'ordem_data': 'vencimento_crescente'}) %}
    {% set url_venc_decresc = url_params.copy() %}
    {% set _ = url_venc_decresc.update({'ordem_data': 'vencimento_decrescente'}) %}
    <a href="{{ url_for('listar_vendas', **url_venc_cresc) }}" class="px-4 py-2 rounded-xl text-sm font-medium transition {{ 'bg-emerald-700 text-white' if ordem_data == 'vencimento_crescente' else 'bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 text-gray-700 dark:text-gray-200 hover:bg-emerald-50 dark:hover:bg-gray-700 hover:border-emerald-200 dark:hover:border-emerald-600' }}">
        <i data-lucide="calendar-clock" class="w-4 h-4 inline-block mr-1.5 align-middle"></i>Vencimento Pr√≥ximo
    </a>
    <a href="{{ url_for('listar_vendas', **url_venc_decresc) }}" class="px-4 py-2 rounded-xl text-sm font-medium transition {{ 'bg-emerald-700 text-white' if ordem_data == 'vencimento_decrescente' else 'bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 text-gray-700 dark:text-gray-200 hover:bg-emerald-50 dark:hover:bg-gray-700 hover:border-emerald-200 dark:hover:border-emerald-600' }}">
        <i data-lucide="calendar-clock" class="w-4 h-4 inline-block mr-1.5 align-middle"></i>Vencimento Distante
    </a>
    <span class="text-gray-300 dark:text-gray-600">|</span>
    {% if filtro_vencidos %}
        {% set url_sem_vencidos = {} %}
        {% if request.args.get('produto_id') %}{% set _ = url_sem_vencidos.update({'produto_id': request.args.get('produto_id')}) %}{% endif %}
        {% if request.args.get('cliente_id') %}{% set _ = url_sem_vencidos.update({'cliente_id': request.args.get('cliente_id')}) %}{% endif %}
        {% set _ = url_sem_vencidos.update({'ordem_data': ordem_data}) %}
        <a href="{{ url_for('listar_vendas', **url_sem_vencidos) }}" class="px-4 py-2 rounded-xl text-sm font-medium bg-red-100 dark:bg-red-900/40 text-red-800 dark:text-red-300 border border-red-200 dark:border-red-800 hover:bg-red-200 dark:hover:bg-red-900/60 transition">
            <i data-lucide="x" class="w-4 h-4 inline-block mr-1.5 align-middle"></i>Limpar filtro vencidos
        </a>
    {% else %}
        {% set url_vencidos = url_params.copy() %}
        {% set _ = url_vencidos.update({'filtro_vencidos': 1}) %}
        {% set _ = url_vencidos.update({'ordem_data': ordem_data}) %}
        <a href="{{ url_for('listar_vendas', **url_vencidos) }}" class="px-4 py-2 rounded-xl text-sm font-medium bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 text-gray-700 dark:text-gray-200 hover:bg-amber-50 dark:hover:bg-amber-900/30 hover:border-amber-200 dark:hover:border-amber-700 hover:text-amber-800 dark:hover:text-amber-400 transition">
            <i data-lucide="clipboard-list" class="w-4 h-4 inline-block mr-1.5 align-middle"></i>Ver Vencidos (Enviar para Fornecedor)
        </a>
    {% endif %}
    <span class="text-gray-300 dark:text-gray-600">|</span>
    <div class="flex items-center bg-gray-200 dark:bg-gray-700 rounded-lg p-1" title="Alternar visualiza√ß√£o">
        <button type="button" onclick="mudarVisualizacao('lista')" id="btn-lista" class="p-2 rounded-md text-gray-600 dark:text-gray-300 hover:bg-white dark:hover:bg-gray-600 shadow-sm transition-all" title="Visualiza√ß√£o em lista">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
        </button>
        <button type="button" onclick="mudarVisualizacao('grade')" id="btn-grade" class="p-2 rounded-md text-gray-600 dark:text-gray-300 hover:bg-white dark:hover:bg-gray-600 transition-all" title="Visualiza√ß√£o em cards">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path></svg>
        </button>
    </div>
</div>

<div class="relative">
    <!-- Barra de a√ß√£o em massa (exclus√£o): fixa no topo ao rolar -->
    <div id="bulk-action-bar" class="hidden sticky top-0 z-50 w-full border-b border-red-200 dark:border-red-800 bg-red-50 dark:bg-red-900/40 px-4 py-3 shadow-md flex flex-wrap items-center justify-between gap-3">
        <span id="bulk-action-count" class="text-sm font-medium text-red-800 dark:text-red-200">0 itens selecionados</span>
        <div class="flex items-center gap-2">
            <button type="button" id="bulk-action-cancel" class="rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-600 transition">Cancelar</button>
            <button type="button" id="bulk-action-confirm" class="rounded-lg bg-red-600 px-4 py-2 text-sm font-semibold text-white hover:bg-red-700 transition focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2">Confirmar Exclus√£o</button>
        </div>
    </div>
    <div id="view-lista" class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 shadow-sm dark:shadow-none overflow-hidden">
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700 resizable" data-bulk-module="vendas" data-table-id="vendas" id="tabela-vendas">
                <thead class="bg-gray-50 dark:bg-gray-900/50">
                    <tr>
                        <th class="px-3 py-3 text-center w-12">
                            <input type="checkbox" id="bulk-master" class="rounded border-gray-300 dark:border-gray-600 text-emerald-600 focus:ring-emerald-500" title="Selecionar todos" aria-label="Selecionar todos">
                        </th>
                        <th class="px-4 py-3 text-left w-12"></th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Data</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Cliente</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">NF</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Pre√ßo Unit.</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Qtd Total</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Valor Total</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Lucro Total</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Vencimento</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">EMPRESA</th>
                        {% set url_th_situacao = {} %}
                        {% if request.args.get('produto_id') %}{% set _ = url_th_situacao.update({'produto_id': request.args.get('produto_id')}) %}{% endif %}
                        {% if request.args.get('cliente_id') %}{% set _ = url_th_situacao.update({'cliente_id': request.args.get('cliente_id')}) %}{% endif %}
                        {% if filtro_vencidos %}{% set _ = url_th_situacao.update({'filtro_vencidos': 1}) %}{% endif %}
                        {% set _ = url_th_situacao.update({'ordem_data': ordem_data}) %}
                        {% set _ = url_th_situacao.update({'ordenar_por': 'situacao'}) %}
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                            <a href="{{ url_for('listar_vendas', **url_th_situacao) }}" class="flex items-center gap-1 no-underline text-inherit">
                                SITUA√á√ÉO
                                <svg class="w-3 h-3 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"></path></svg>
                            </a>
                        </th>
                        {% set url_th_forma = {} %}
                        {% if request.args.get('produto_id') %}{% set _ = url_th_forma.update({'produto_id': request.args.get('produto_id')}) %}{% endif %}
                        {% if request.args.get('cliente_id') %}{% set _ = url_th_forma.update({'cliente_id': request.args.get('cliente_id')}) %}{% endif %}
                        {% if filtro_vencidos %}{% set _ = url_th_forma.update({'filtro_vencidos': 1}) %}{% endif %}
                        {% set _ = url_th_forma.update({'ordem_data': ordem_data}) %}
                        {% set _ = url_th_forma.update({'ordenar_por': 'forma_pagamento'}) %}
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                            <a href="{{ url_for('listar_vendas', **url_th_forma) }}" class="flex items-center gap-1 no-underline text-inherit">
                                FORMA PAGTO
                                <svg class="w-3 h-3 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"></path></svg>
                            </a>
                        </th>
                        <th class="px-3 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider min-w-[180px] whitespace-nowrap">A√á√ïES</th>
                    </tr>
                </thead>
                <tbody id="vendas-tbody" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                    {% if pedidos %}
                        {% set current_page = pagination.page if pagination else 1 %}
                        {% include '_linhas_venda.html' %}
                    {% else %}
                    <tr id="vendas-empty-row">
                        <td colspan="14" class="px-6 py-8 text-center text-gray-500 dark:text-gray-400">
                            {% if filtro_vencidos %}Nenhum pedido vencido h√° mais de 1 dia (para enviar ao fornecedor).{% else %}Nenhuma venda registrada ainda.{% endif %}
                        </td>
                    </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Vista em Cards (Grade) -->
    <div id="view-grade" class="hidden grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mt-4">
        {% if pedidos %}
        {% for pedido in pedidos %}
        {% set row_vencida = pedido.is_vencido %}
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 p-4 {{ 'border-l-4 border-l-red-500' if row_vencida else 'border-l-4 border-l-emerald-500' }}">
            <div class="flex justify-between items-start mb-2">
                <div>
                    <span class="text-xs text-gray-500 dark:text-gray-400">{{ pedido.data_venda.strftime('%d/%m/%Y') }}</span>
                    <h3 class="font-bold text-lg text-gray-800 dark:text-white">{{ pedido.cliente_nome }}</h3>
                    <span class="text-xs text-gray-500 dark:text-gray-400">NF: {% if pedido.nf and pedido.nf != '-' %}<span onclick="copiarParaClipboard('{{ pedido.nf }}', this)" class="cursor-pointer hover:text-emerald-600 dark:hover:text-emerald-400 hover:underline transition-all font-medium" title="Clique para copiar a NF">{{ pedido.nf }}</span>{% else %}-{% endif %}</span>
                </div>
                {% if pedido.situacao == 'PARCIAL' %}
                <span class="inline-block px-2 py-1 text-xs font-semibold rounded-full bg-orange-100 dark:bg-orange-900/50 text-orange-800 dark:text-orange-300">{{ pedido.situacao }}</span>
                {% else %}
                <button type="button" class="badge-situacao-toggle px-2 py-1 text-xs font-semibold rounded-full cursor-pointer transition focus:outline-none focus:ring-2 {{ 'bg-amber-100 dark:bg-amber-900/50 text-amber-800 dark:text-amber-300 hover:bg-amber-200 dark:hover:bg-amber-800 hover:ring-2 hover:ring-amber-400 focus:ring-amber-400' if pedido.situacao == 'PENDENTE' else 'bg-emerald-100 dark:bg-emerald-900/50 text-emerald-800 dark:text-emerald-300 hover:bg-emerald-200 dark:hover:bg-emerald-800 hover:ring-2 hover:ring-emerald-400 focus:ring-emerald-400' }}"
                    data-venda-id="{{ pedido.primeira_venda_id }}"
                    data-nf="{{ pedido.nf if pedido.nf and pedido.nf != '-' else 'N/A' }}"
                    data-situacao="{{ pedido.situacao }}"
                    data-cliente="{{ pedido.cliente_nome }}"
                    data-valor="{{ pedido.total_valor|formato_moeda }}"
                    data-forma-pagamento="{{ pedido.forma_pagamento or '' }}"
                    title="{{ 'Clique para marcar como pago' if pedido.situacao == 'PENDENTE' else 'Clique para reverter para pendente' }}">{{ pedido.situacao }}</button>
                {% endif %}
            </div>
            <div class="text-sm text-gray-600 dark:text-gray-300 mb-3">
                <p class="text-gray-500 dark:text-gray-400">üì¶ {{ pedido.total_quantidade }} itens</p>
                <p class="font-bold text-emerald-600 dark:text-emerald-400 text-lg mt-1 valor-financeiro">{{ pedido.total_valor|formato_moeda }}</p>
                <p class="text-xs mt-1">üìÖ Venc.: {% if pedido.data_vencimento %}{{ pedido.data_vencimento.strftime('%d/%m/%Y') }}{% else %}---{% endif %}</p>
            </div>
            <div class="flex justify-end gap-2 pt-3 border-t border-gray-100 dark:border-gray-700 flex-wrap">
                <a href="{{ url_for('enviar_whatsapp_boleto', id=pedido.primeira_venda_id) }}" target="_blank" rel="noopener noreferrer" class="p-1.5 rounded text-green-600 dark:text-green-400 hover:bg-green-50 dark:hover:bg-green-900/30 transition-transform hover:scale-110" title="Enviar cobran√ßa com link do boleto no WhatsApp">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/></svg>
                </a>
                {% if pedido.caminho_nf %}
                <a href="{{ url_for('ver_nf_venda', id=pedido.primeira_venda_id) }}" target="_blank" rel="noopener noreferrer" class="p-1.5 rounded text-blue-600 dark:text-blue-400 hover:bg-blue-50 dark:hover:bg-blue-900/30 transition-transform hover:scale-110" title="Visualizar Nota Fiscal">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                </a>
                {% endif %}
                {% if pedido.caminho_boleto %}
                <a href="{{ url_for('ver_boleto_venda', id=pedido.primeira_venda_id) }}" target="_blank" rel="noopener noreferrer" class="p-1.5 rounded text-amber-600 dark:text-amber-400 hover:bg-amber-50 dark:hover:bg-amber-900/30 transition-transform hover:scale-110" title="Visualizar Boleto">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M3 14h18m-9-4v8m-7 0h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
                </a>
                {% endif %}
                <a href="{{ url_for('recibo_venda', id=pedido.primeira_venda_id) }}" target="_blank" rel="noopener noreferrer" class="p-1.5 rounded text-blue-600 dark:text-blue-400 hover:bg-blue-50 dark:hover:bg-blue-900/30 transition-transform hover:scale-110" title="Imprimir Recibo"><i data-lucide="printer" class="w-5 h-5"></i></a>
                {% set v0 = pedido.vendas[0] if pedido.vendas else None %}
                {% if v0 %}
                <button type="button" class="btn-editar-venda p-1.5 rounded text-blue-500 hover:text-blue-700 dark:text-blue-400 dark:hover:text-blue-300 hover:bg-blue-50 dark:hover:bg-blue-900/30 transition-transform hover:scale-110 bg-transparent border-none cursor-pointer" title="Editar Venda (Mudar para Pago)"
                    data-id="{{ v0.id }}"
                    data-cliente-id="{{ v0.cliente_id }}"
                    data-produto-id="{{ v0.produto_id }}"
                    data-qtd="{{ v0.quantidade_venda }}"
                    data-preco="{{ v0.preco_venda }}"
                    data-nf="{{ v0.nf or '' }}"
                    data-data="{{ v0.data_venda.strftime('%Y-%m-%d') }}"
                    data-empresa="{{ v0.empresa_faturadora or '' }}"
                    data-situacao="{{ v0.situacao or 'PENDENTE' }}"
                    data-forma-pagamento="{{ v0.forma_pagamento or '' }}">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg>
                </button>
                {% endif %}
                <form action="{{ url_for('excluir_venda', id=pedido.primeira_venda_id) }}" method="POST" class="inline form-excluir-pedido" data-cliente="{{ pedido.cliente_nome }}" data-nf="{{ pedido.nf }}" data-data="{{ pedido.data_venda.strftime('%d/%m/%Y') }}">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <button type="submit" class="p-1.5 rounded text-red-600 dark:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/30 transition-transform hover:scale-110" title="Excluir Pedido" onclick="return confirm('Excluir este pedido?');"><i data-lucide="trash-2" class="w-5 h-5"></i></button>
                </form>
            </div>
        </div>
        {% endfor %}
        {% else %}
        <div class="col-span-full bg-white dark:bg-gray-800 p-10 rounded-xl text-center text-gray-500 dark:text-gray-400 italic border border-gray-100 dark:border-gray-700">
            {% if filtro_vencidos %}Nenhum pedido vencido.{% else %}Nenhuma venda registrada ainda.{% endif %}
        </div>
        {% endif %}
    </div>

    <!-- Sentinela Scroll Infinito (vis√≠vel em Lista e Grade) -->
    {% if pagination and pagination.has_next %}
    <div id="sentinela-scroll" class="w-full text-center py-6">
        <div class="inline-flex items-center gap-2 text-gray-500 dark:text-gray-400">
            <svg class="animate-spin h-5 w-5 text-emerald-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <span class="text-sm font-medium">Buscando mais vendas...</span>
        </div>
    </div>
    {% endif %}
</div>

<!-- Modal Confirma√ß√£o Exclus√£o em Massa -->
<div id="modal-bulk-delete-backdrop" class="fixed inset-0 z-40 hidden bg-black/40 backdrop-blur-sm" aria-hidden="true"></div>
<div id="modal-bulk-delete" class="fixed left-1/2 top-1/2 z-50 hidden w-full max-w-md -translate-x-1/2 -translate-y-1/2 rounded-lg bg-white dark:bg-gray-800 shadow-2xl dark:shadow-none" role="dialog" aria-labelledby="modal-bulk-delete-titulo" aria-modal="true">
    <div class="rounded-t-lg bg-red-600 px-6 py-4">
        <h3 id="modal-bulk-delete-titulo" class="text-lg font-bold text-white">Confirmar exclus√£o em massa</h3>
    </div>
    <div class="px-6 py-5">
        <p id="modal-bulk-delete-msg" class="text-gray-700 dark:text-gray-300">Tem certeza?</p>
    </div>
    <div class="flex justify-end gap-3 rounded-b-lg border-t border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-900/50 px-6 py-4">
        <button type="button" id="modal-bulk-delete-cancel" class="rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-600 transition">Cancelar</button>
        <button type="button" id="modal-bulk-delete-ok" class="rounded-lg bg-red-600 px-4 py-2 text-sm font-semibold text-white hover:bg-red-700 transition focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2">Excluir</button>
    </div>
</div>

<!-- Modal Confirmar Recebimento (Pagamento) -->
<div id="modal-confirmar-pagamento-backdrop" class="fixed inset-0 z-40 hidden bg-black/40 backdrop-blur-sm" aria-hidden="true"></div>
<div id="modal-confirmar-pagamento" class="fixed left-1/2 top-1/2 z-50 hidden w-full max-w-md -translate-x-1/2 -translate-y-1/2 rounded-lg bg-white dark:bg-gray-800 shadow-2xl dark:shadow-none" role="dialog" aria-labelledby="modal-confirmar-titulo" aria-modal="true">
    <div class="rounded-t-lg bg-emerald-800 px-6 py-4">
        <h3 id="modal-confirmar-titulo" class="text-lg font-bold text-white">Confirmar Recebimento</h3>
    </div>
    <div class="px-6 py-5">
        <div class="space-y-2 text-sm text-gray-700 dark:text-gray-300">
            <p><span class="font-medium text-gray-500 dark:text-gray-400">Cliente:</span> <strong id="modal-confirmar-cliente">‚Äî</strong></p>
            <p><span class="font-medium text-gray-500 dark:text-gray-400">NF:</span> <span id="modal-confirmar-nf">‚Äî</span></p>
            <p><span class="font-medium text-gray-500 dark:text-gray-400">Valor Total:</span> <span id="modal-confirmar-valor" class="font-bold text-emerald-600 dark:text-emerald-400">‚Äî</span></p>
        </div>
        <div class="mt-4 mb-4 bg-emerald-50 dark:bg-emerald-900/20 p-4 rounded-lg border border-emerald-100 dark:border-emerald-800">
            <label class="block text-sm font-bold text-emerald-800 dark:text-emerald-300 mb-2 flex items-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path></svg>
                Cair em qual conta do Caixa?
            </label>
            <select id="modal-confirmar-forma-pagamento" name="forma_pagamento" class="w-full rounded-lg border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-emerald-500 focus:ring-emerald-500 font-medium">
                <option value="Dinheiro">üíµ Dinheiro (Esp√©cie)</option>
                <option value="Pix">üì± Pix / Transfer√™ncia</option>
                <option value="Cheque">üìù Cheque</option>
                <option value="Boleto">üìÑ Boleto</option>
            </select>
            <p class="text-xs text-emerald-600 dark:text-emerald-400 mt-2 font-medium">* O valor ser√° lan√ßado automaticamente no seu Livro Caixa de hoje.</p>
        </div>
        <p class="text-gray-600 dark:text-gray-400">Voc√™ confirma que o pagamento deste pedido foi recebido?</p>
    </div>
    <div class="flex justify-end gap-3 rounded-b-lg border-t border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-900/50 px-6 py-4">
        <button type="button" id="modal-confirmar-cancelar" class="rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-200 shadow-sm hover:bg-gray-50 dark:hover:bg-gray-600 transition">Cancelar</button>
        <button type="button" id="modal-confirmar-ok" class="inline-flex items-center gap-2 rounded-lg bg-emerald-600 px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-emerald-700 transition focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:ring-offset-2">
            <i data-lucide="check" class="w-4 h-4"></i> Confirmar Pagamento
        </button>
    </div>
</div>

<!-- Modal Editar Venda -->
<div id="modal-editar-venda-wrap" class="fixed inset-0 z-50 hidden" aria-hidden="true">
    <div class="fixed inset-0 bg-black/50" id="modal-editar-venda-overlay"></div>
    <div class="fixed left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 w-full max-w-2xl max-h-[90vh] overflow-y-auto bg-white dark:bg-gray-800 rounded-xl shadow-sm dark:shadow-none border border-gray-200 dark:border-gray-700 z-50" onclick="event.stopPropagation()">
        <div class="sticky top-0 flex justify-between items-center px-8 py-5 bg-emerald-700 text-white rounded-t-xl z-10">
            <h3 class="text-xl font-bold flex items-center">
                <i data-lucide="pencil" class="w-5 h-5 mr-2"></i>Editar Venda
            </h3>
            <button type="button" class="modal-editar-venda-fechar w-10 h-10 flex items-center justify-center rounded-full hover:bg-emerald-600 text-white font-bold transition" title="Fechar">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>
        </div>
        <div class="p-8">
            <form id="form-editar-venda" method="POST" action="" data-action-base="{{ url_for('editar_venda', id=0) }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="mb-4">
                        <label for="edit_cliente_id" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Cliente <span class="text-red-500">*</span></label>
                        <select id="edit_cliente_id" name="cliente_id" required class="w-full px-4 py-2.5 border border-gray-200 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 dark:bg-gray-700 dark:text-gray-100">
                            <option value="">Selecione...</option>
                            {% for c in todos_clientes %}
                            <option value="{{ c.id }}">{{ c.nome_cliente }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-4">
                        <label for="edit_produto_id" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Produto <span class="text-red-500">*</span></label>
                        <select id="edit_produto_id" name="produto_id" required class="w-full px-4 py-2.5 border border-gray-200 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 dark:bg-gray-700 dark:text-gray-100">
                            <option value="">Selecione...</option>
                            {% for p in todos_produtos %}
                            {% set nome_lower = p.nome_produto|lower %}
                            {% if 'alho' in nome_lower %}{% set emoji = 'üßÑ' %}{% elif 'cafe' in nome_lower or 'caf√©' in nome_lower %}{% set emoji = '‚òï' %}{% elif 'sacola' in nome_lower %}{% set emoji = 'üõçÔ∏è' %}{% else %}{% set emoji = 'üì¶' %}{% endif %}
                            <option value="{{ p.id }}">{{ emoji }} {{ p.nome_produto }} (Estoque: {{ p.estoque_atual }})</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-4">
                        <label for="edit_quantidade_venda" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Quantidade <span class="text-red-500">*</span></label>
                        <input type="number" id="edit_quantidade_venda" name="quantidade_venda" min="1" required inputmode="decimal" class="w-full px-4 py-2.5 border border-gray-200 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 dark:bg-gray-700 dark:text-gray-100">
                    </div>
                    <div class="mb-4">
                        <label for="edit_preco_venda" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Pre√ßo de Venda <span class="text-red-500">*</span></label>
                        <input type="text" id="edit_preco_venda" name="preco_venda" required placeholder="0,00" inputmode="decimal" class="w-full px-4 py-2.5 border border-gray-200 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 dark:bg-gray-700 dark:text-gray-100" oninput="mascaraMoeda(this)" autocomplete="off">
                    </div>
                    <div class="mb-4">
                        <label for="edit_nf" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Nota Fiscal</label>
                        <input type="text" id="edit_nf" name="nf" class="w-full px-4 py-2.5 border border-gray-200 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 dark:bg-gray-700 dark:text-gray-100">
                    </div>
                    <div class="mb-4">
                        <label for="edit_data_venda" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Data da Venda</label>
                        <input type="date" id="edit_data_venda" name="data_venda" class="w-full text-xs md:text-sm px-2 py-2.5 rounded-xl border border-gray-200 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 shadow-sm focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 appearance-none text-center md:text-left">
                    </div>
                    <div class="mb-4">
                        <label for="edit_empresa_faturadora" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Empresa Faturadora <span class="text-red-500">*</span></label>
                        <select id="edit_empresa_faturadora" name="empresa_faturadora" required class="w-full px-4 py-2.5 border border-gray-200 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 dark:bg-gray-700 dark:text-gray-100">
                            <option value="">Selecione...</option>
                            <option value="DESTAK">DESTAK</option>
                            <option value="PATY">PATY</option>
                            <option value="NENHUM">NENHUM</option>
                        </select>
                    </div>
                    <div class="mb-4">
                        <label for="edit_situacao" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Situa√ß√£o <span class="text-red-500">*</span></label>
                        <select id="edit_situacao" name="situacao" required class="w-full px-4 py-2.5 border border-gray-200 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 dark:bg-gray-700 dark:text-gray-100">
                            <option value="PENDENTE">‚è≥ Pendente</option>
                            <option value="PARCIAL">üîÑ Parcial</option>
                            <option value="PAGO">‚úÖ Pago</option>
                        </select>
                    </div>
                    <div class="mb-4">
                        <label for="edit_forma_pagamento" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Forma de Pagto</label>
                        <select id="edit_forma_pagamento" name="forma_pagamento" class="w-full px-4 py-2.5 border border-gray-200 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 dark:bg-gray-700 dark:text-gray-100">
                            <option value="">Selecione...</option>
                            <option value="BOLETO">üìÑ Boleto</option>
                            <option value="DINHEIRO">üíµ Dinheiro</option>
                            <option value="PIX">üí† Pix</option>
                            <option value="CHEQUE">‚úçÔ∏è Cheque</option>
                            <option value="TRANSFERENCIA">üè¶ Transfer√™ncia</option>
                        </select>
                    </div>
                </div>
                <div class="flex gap-4 mt-6">
                    <button type="submit" class="bg-emerald-700 text-white px-6 py-2.5 rounded-xl hover:bg-emerald-600 transition flex items-center font-medium" id="btn-salvar-editar-venda">
                        <i data-lucide="check" class="w-4 h-4 mr-2"></i>Salvar
                    </button>
                    <button type="button" class="modal-editar-venda-fechar bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-200 px-6 py-2.5 rounded-xl hover:bg-gray-300 dark:hover:bg-gray-600 transition flex items-center font-medium">
                        <i data-lucide="x" class="w-4 h-4 mr-2"></i>Cancelar
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Adicionar Item a Venda Existente -->
<div id="modalAddItemExistente-wrap" class="fixed inset-0 z-50 hidden" aria-hidden="true">
    <div class="fixed inset-0 bg-black/50" id="modalAddItemExistente-overlay"></div>
    <div class="fixed left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 w-full max-w-md bg-white dark:bg-gray-800 rounded-xl shadow-sm dark:shadow-none border border-gray-200 dark:border-gray-700 z-50" onclick="event.stopPropagation()">
        <div class="flex justify-between items-center px-6 py-4 bg-emerald-700 text-white rounded-t-xl">
            <h3 class="text-lg font-bold flex items-center">
                <i data-lucide="plus-circle" class="w-5 h-5 mr-2"></i>Adicionar Produto ao Pedido
            </h3>
            <button type="button" class="modalAddItemExistente-fechar w-9 h-9 flex items-center justify-center rounded-full hover:bg-emerald-600 text-white font-bold transition" title="Fechar">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>
        </div>
        <form id="form-add-item-existente" method="POST" action="{{ url_for('venda_adicionar_item') }}" class="p-6">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
            <input type="hidden" name="venda_id" id="add-item-venda-id" value="">
            <div class="space-y-4">
                <div>
                    <label for="add-item-produto_id" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Produto <span class="text-red-500">*</span></label>
                    <select id="add-item-produto_id" name="produto_id" required class="w-full px-4 py-2.5 border border-gray-200 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 dark:bg-gray-700 dark:text-gray-100">
                        <option value="">Selecione o produto</option>
                        {% for p in produtos %}
                        {% set nome_lower = p.nome_produto|lower %}
                        {% if 'alho' in nome_lower %}{% set emoji = 'üßÑ' %}{% elif 'cafe' in nome_lower or 'caf√©' in nome_lower %}{% set emoji = '‚òï' %}{% elif 'sacola' in nome_lower %}{% set emoji = 'üõçÔ∏è' %}{% else %}{% set emoji = 'üì¶' %}{% endif %}
                        <option value="{{ p.id }}" data-estoque="{{ p.estoque_atual }}">{{ emoji }} {{ p.nome_produto }} (Est.: {{ p.estoque_atual }})</option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <label for="add-item-quantidade" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Quantidade <span class="text-red-500">*</span></label>
                    <input type="number" id="add-item-quantidade" name="quantidade_venda" min="1" required class="w-full px-4 py-2.5 border border-gray-200 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 dark:bg-gray-700 dark:text-gray-100">
                </div>
                <div>
                    <label for="add-item-preco" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Pre√ßo Unit√°rio <span class="text-red-500">*</span></label>
                    <input type="text" id="add-item-preco" name="preco_venda" required placeholder="R$ 0,00" inputmode="decimal" class="add-item-preco-input w-full px-4 py-2.5 border border-gray-200 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 dark:bg-gray-700 dark:text-gray-100" autocomplete="off">
                </div>
            </div>
            <div class="flex gap-3 mt-6">
                <button type="submit" class="flex-1 bg-emerald-700 text-white px-4 py-2.5 rounded-xl hover:bg-emerald-600 transition font-medium flex items-center justify-center gap-2">
                    <i data-lucide="check" class="w-4 h-4"></i> Adicionar
                </button>
                <button type="button" class="modalAddItemExistente-fechar bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-200 px-4 py-2.5 rounded-xl hover:bg-gray-300 dark:hover:bg-gray-600 transition font-medium">
                    Cancelar
                </button>
            </div>
        </form>
    </div>
</div>

<script>
(function() {
    // Bulk delete desabilitado na estrutura de pedidos agrupados
    // (Cada pedido tem seu pr√≥prio bot√£o de exclus√£o)
    
    // Interceptar exclus√£o de pedidos completos
    var formsExcluirPedido = document.querySelectorAll('.form-excluir-pedido');
    formsExcluirPedido.forEach(function(form) {
        form.addEventListener('submit', function(e) {
            var cliente = form.getAttribute('data-cliente');
            var nf = form.getAttribute('data-nf');
            var data = form.getAttribute('data-data');
            var mensagem = 'Isso excluir√° todos os itens vinculados a esta NF (Cliente: ' + cliente + ', NF: ' + nf + ', Data: ' + data + '). Deseja continuar?';
            if (!confirm(mensagem)) {
                e.preventDefault();
                return false;
            }
        });
    });
    
    // Accordion: Expandir/Colapsar pedidos
    function initAccordion() {
        var linhasResumo = document.querySelectorAll('.pedido-resumo');
        linhasResumo.forEach(function(linha) {
            // Verificar se j√° tem listener para evitar duplica√ß√£o
            if (linha.hasAttribute('data-accordion-initialized')) return;
            linha.setAttribute('data-accordion-initialized', 'true');
            
            linha.addEventListener('click', function(e) {
                // N√£o expandir se clicar em a√ß√µes, formul√°rios ou checkbox de bulk
                if (e.target.closest('a, button, form, input')) {
                    return;
                }
                
                var pedidoId = linha.getAttribute('data-pedido-id');
                var detalhes = document.querySelector('.pedido-detalhes[data-pedido-id="' + pedidoId + '"]');
                var chevron = linha.querySelector('.pedido-chevron');
                
                if (detalhes) {
                    var isHidden = detalhes.classList.contains('hidden');
                    
                    if (isHidden) {
                        // Expandir
                        detalhes.classList.remove('hidden');
                        if (chevron) {
                            chevron.style.transform = 'rotate(180deg)';
                        }
                    } else {
                        // Colapsar
                        detalhes.classList.add('hidden');
                        if (chevron) {
                            chevron.style.transform = 'rotate(0deg)';
                        }
                    }
                    
                    // Atualizar √≠cones Lucide ap√≥s mudan√ßa
                    if (typeof lucide !== 'undefined') {
                        lucide.createIcons();
                    }
                }
            });
        });
    }
    
    // Inicializar accordion ao carregar
    initAccordion();
    
    // Toggle de status: PENDENTE ‚Üî PAGO (delega√ß√£o para badges din√¢micos)
    var tbody = document.getElementById('vendas-tbody');
    var modalBackdrop = document.getElementById('modal-confirmar-pagamento-backdrop');
    var modalEl = document.getElementById('modal-confirmar-pagamento');
    var modalCancel = document.getElementById('modal-confirmar-cancelar');
    var modalOk = document.getElementById('modal-confirmar-ok');
    var modalConfirmarBtn = null;

    function openModalConfirmar(btn) {
        var cliente = btn.getAttribute('data-cliente') || '‚Äî';
        var nf = btn.getAttribute('data-nf') || 'N/A';
        var valor = btn.getAttribute('data-valor') || '‚Äî';
        var formaPag = (btn.getAttribute('data-forma-pagamento') || '').trim();
        document.getElementById('modal-confirmar-cliente').textContent = cliente;
        document.getElementById('modal-confirmar-nf').textContent = nf;
        document.getElementById('modal-confirmar-valor').textContent = valor;
        var selectCaixa = document.getElementById('modal-confirmar-forma-pagamento');
        if (selectCaixa && formaPag && formaPag !== 'None') {
            var fp = formaPag.toUpperCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
            var matched = false;
            for (var i = 0; i < selectCaixa.options.length; i++) {
                var optVal = selectCaixa.options[i].value.toUpperCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
                var optTxt = selectCaixa.options[i].text.toUpperCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
                if (optVal === fp || optTxt.indexOf(fp) !== -1) {
                    selectCaixa.value = selectCaixa.options[i].value;
                    matched = true;
                    break;
                }
            }
            if (matched) {
                selectCaixa.classList.add('ring-2', 'ring-emerald-500', 'transition-all');
                setTimeout(function() { selectCaixa.classList.remove('ring-2', 'ring-emerald-500'); }, 1200);
            }
        }
        modalConfirmarBtn = btn;
        modalBackdrop.classList.remove('hidden');
        modalEl.classList.remove('hidden');
        if (typeof lucide !== 'undefined') lucide.createIcons();
    }

    function closeModalConfirmar() {
        modalBackdrop.classList.add('hidden');
        modalEl.classList.add('hidden');
        modalConfirmarBtn = null;
    }

    function execAtualizarStatus(btn, situacao, formaPagamento, onSuccess) {
        var id = btn.getAttribute('data-venda-id');
        var nf = btn.getAttribute('data-nf') || 'N/A';
        var cliente = btn.getAttribute('data-cliente') || '';
        var valor = btn.getAttribute('data-valor') || '';
        btn.disabled = true;
        var url = '/venda/atualizar_status/' + id;
        var opts = { method: 'POST', headers: Object.assign({ 'X-Requested-With': 'XMLHttpRequest' }, window.getCsrfHeaders ? window.getCsrfHeaders() : {}) };
        if (situacao === 'PENDENTE' && formaPagamento) {
            var fd = new FormData();
            fd.append('forma_pagamento', formaPagamento);
            opts.body = fd;
        }
        fetch(url, opts).then(function(r) { return r.json(); }).then(function(data) {
            if (data.ok) {
                var novo = data.novo_status || (situacao === 'PENDENTE' ? 'PAGO' : 'PENDENTE');
                var replacement = document.createElement('button');
                replacement.type = 'button';
                replacement.className = 'badge-situacao-toggle badge-status-transition px-3 py-1 text-xs font-semibold rounded-full transition focus:outline-none focus:ring-2 ' +
                    (novo === 'PAGO'
                        ? 'bg-emerald-100 dark:bg-emerald-900/50 text-emerald-800 dark:text-emerald-300 hover:bg-emerald-200 dark:hover:bg-emerald-800 hover:ring-2 hover:ring-emerald-400 focus:ring-emerald-400 cursor-pointer'
                        : 'bg-amber-100 dark:bg-amber-900/50 text-amber-800 dark:text-amber-300 hover:bg-amber-200 dark:hover:bg-amber-800 hover:ring-2 hover:ring-amber-400 focus:ring-amber-400 cursor-pointer');
                replacement.setAttribute('data-venda-id', id);
                replacement.setAttribute('data-nf', nf);
                replacement.setAttribute('data-situacao', novo);
                replacement.setAttribute('data-cliente', cliente);
                replacement.setAttribute('data-valor', valor);
                replacement.setAttribute('data-forma-pagamento', btn.getAttribute('data-forma-pagamento') || formaPagamento || '');
                replacement.title = novo === 'PAGO' ? 'Clique para reverter para pendente' : 'Clique para marcar como pago';
                replacement.textContent = novo;
                btn.parentNode.replaceChild(replacement, btn);
                setTimeout(function() { replacement.classList.remove('badge-status-transition'); }, 400);
                if (onSuccess) onSuccess();
            } else {
                alert(data.mensagem || 'Erro ao atualizar.');
                btn.disabled = false;
            }
        }).catch(function() {
            alert('Erro ao atualizar. Tente novamente.');
            btn.disabled = false;
        });
    }

    if (modalCancel) modalCancel.addEventListener('click', closeModalConfirmar);
    if (modalBackdrop) modalBackdrop.addEventListener('click', closeModalConfirmar);
    if (modalOk) {
        modalOk.addEventListener('click', function() {
            if (!modalConfirmarBtn) return;
            var btn = modalConfirmarBtn;
            var situacao = btn.getAttribute('data-situacao');
            var selForma = document.getElementById('modal-confirmar-forma-pagamento');
            var formaPagamento = selForma ? selForma.value : 'Dinheiro';
            closeModalConfirmar();
            execAtualizarStatus(btn, situacao, formaPagamento);
        });
    }

    function handleBadgeClick(e) {
        var btn = e.target.closest('.badge-situacao-toggle');
        if (!btn) return;
        e.stopPropagation();
        e.preventDefault();
        var nf = btn.getAttribute('data-nf') || 'N/A';
        var situacao = btn.getAttribute('data-situacao');
        if (situacao === 'PENDENTE') {
            openModalConfirmar(btn);
            return;
        }
        var msg = 'O pagamento foi um erro? Alterar pedido [NF ' + nf + '] de volta para PENDENTE?';
        if (!confirm(msg)) return;
        execAtualizarStatus(btn, situacao, null);
    }

    if (tbody) {
        tbody.addEventListener('click', handleBadgeClick);
    }

    var viewGrade = document.getElementById('view-grade');
    if (viewGrade) {
        viewGrade.addEventListener('click', handleBadgeClick);
    }
    
    // Inicializar √≠cones Lucide ao carregar
    if (typeof lucide !== 'undefined') {
        lucide.createIcons();
    }
})();

// Modal Editar Venda: abrir ao clicar no l√°pis, preencher com data-* e confirmar antes de enviar
(function() {
    var wrap = document.getElementById('modal-editar-venda-wrap');
    var form = document.getElementById('form-editar-venda');
    var overlay = document.getElementById('modal-editar-venda-overlay');
    var btnsFechar = document.querySelectorAll('.modal-editar-venda-fechar');
    var actionBase = form && form.getAttribute('data-action-base');
    if (!actionBase) actionBase = '';

    function abrirModalEditarVenda(btn) {
        var id = btn.getAttribute('data-id');
        var clienteId = btn.getAttribute('data-cliente-id') || '';
        var produtoId = btn.getAttribute('data-produto-id') || '';
        var qtd = btn.getAttribute('data-qtd') || '1';
        var preco = btn.getAttribute('data-preco') || '';
        var nf = btn.getAttribute('data-nf') || '';
        var data = btn.getAttribute('data-data') || '';
        var empresa = btn.getAttribute('data-empresa') || '';
        var situacao = btn.getAttribute('data-situacao') || 'PENDENTE';
        var formaPagamento = btn.getAttribute('data-forma-pagamento') || '';

        form.action = actionBase.replace(/\/0$/, '/') + id;
        document.getElementById('edit_cliente_id').value = clienteId;
        document.getElementById('edit_produto_id').value = produtoId;
        document.getElementById('edit_quantidade_venda').value = qtd;
        document.getElementById('edit_preco_venda').value = (typeof formatarMoedaParaExibir === 'function' ? formatarMoedaParaExibir(preco) : preco) || preco;
        document.getElementById('edit_nf').value = nf;
        document.getElementById('edit_data_venda').value = data;
        document.getElementById('edit_empresa_faturadora').value = empresa;
        document.getElementById('edit_situacao').value = situacao;
        var editFormaPag = document.getElementById('edit_forma_pagamento');
        if (editFormaPag) editFormaPag.value = formaPagamento;

        wrap.classList.remove('hidden');
        document.body.style.overflow = 'hidden';
        if (typeof lucide !== 'undefined') lucide.createIcons();
    }

    function fecharModalEditarVenda() {
        wrap.classList.add('hidden');
        document.body.style.overflow = '';
    }

    document.querySelectorAll('.btn-editar-venda').forEach(function(btn) {
        btn.addEventListener('click', function() { abrirModalEditarVenda(btn); });
    });
    if (overlay) overlay.addEventListener('click', fecharModalEditarVenda);
    btnsFechar.forEach(function(b) { b.addEventListener('click', fecharModalEditarVenda); });

    if (form) {
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            if (!confirm('Tem certeza que deseja alterar essa venda?')) return;
            form.submit();
        });
    }
})();

// Modal Adicionar Item a Venda Existente
function abrirModalAddItem(idVenda) {
    var wrap = document.getElementById('modalAddItemExistente-wrap');
    var vendaIdInput = document.getElementById('add-item-venda-id');
    var produtoSelect = document.getElementById('add-item-produto_id');
    var quantidadeInput = document.getElementById('add-item-quantidade');
    var precoInput = document.getElementById('add-item-preco');
    if (!wrap || !vendaIdInput) return;
    vendaIdInput.value = String(idVenda || '');
    if (produtoSelect) produtoSelect.value = '';
    if (quantidadeInput) quantidadeInput.value = '1';
    if (precoInput) precoInput.value = '';
    wrap.classList.remove('hidden');
    document.body.style.overflow = 'hidden';
    if (typeof lucide !== 'undefined') lucide.createIcons();
}

(function() {
    var wrap = document.getElementById('modalAddItemExistente-wrap');
    var overlay = document.getElementById('modalAddItemExistente-overlay');
    var btnsFechar = document.querySelectorAll('.modalAddItemExistente-fechar');
    var precoInput = document.getElementById('add-item-preco');

    function fecharModalAddItem() {
        if (wrap) wrap.classList.add('hidden');
        document.body.style.overflow = '';
    }

    if (overlay) overlay.addEventListener('click', fecharModalAddItem);
    if (btnsFechar.length) btnsFechar.forEach(function(b) { b.addEventListener('click', fecharModalAddItem); });

    // M√°scara de moeda no input de pre√ßo
    if (precoInput) {
        function formatPreco(val) {
            if (val === null || val === undefined || isNaN(val)) return 'R$ 0,00';
            return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(val);
        }
        precoInput.addEventListener('input', function() {
            var raw = (this.value || '').replace(/\D/g, '');
            if (raw === '') { this.value = ''; return; }
            var num = parseInt(raw, 10) / 100;
            this.value = formatPreco(num);
        });
    }
})();

// Altern√¢ncia Lista / Grade (persistente em localStorage)
function mudarVisualizacao(modo) {
    var lista = document.getElementById('view-lista');
    var grade = document.getElementById('view-grade');
    var btnLista = document.getElementById('btn-lista');
    var btnGrade = document.getElementById('btn-grade');
    var activeClasses = ['bg-white', 'dark:bg-gray-600', 'shadow', 'text-emerald-600', 'dark:text-emerald-400'];
    var inactiveClasses = ['text-gray-600', 'dark:text-gray-300'];
    if (!lista || !grade) return;
    if (modo === 'grade') {
        lista.classList.add('hidden');
        grade.classList.remove('hidden');
        if (btnGrade) { activeClasses.forEach(function(c) { btnGrade.classList.add(c); }); inactiveClasses.forEach(function(c) { btnGrade.classList.remove(c); }); }
        if (btnLista) { activeClasses.forEach(function(c) { btnLista.classList.remove(c); }); inactiveClasses.forEach(function(c) { btnLista.classList.add(c); }); }
    } else {
        lista.classList.remove('hidden');
        grade.classList.add('hidden');
        if (btnLista) { activeClasses.forEach(function(c) { btnLista.classList.add(c); }); inactiveClasses.forEach(function(c) { btnLista.classList.remove(c); }); }
        if (btnGrade) { activeClasses.forEach(function(c) { btnGrade.classList.remove(c); }); inactiveClasses.forEach(function(c) { btnGrade.classList.add(c); }); }
    }
    localStorage.setItem('vendas_view_mode', modo);
    if (typeof lucide !== 'undefined') lucide.createIcons();
}
document.addEventListener('DOMContentLoaded', function() {
    var savedMode = localStorage.getItem('vendas_view_mode') || 'lista';
    mudarVisualizacao(savedMode);
});

(function() {
    // Bulk delete: checkboxes, barra flutuante, modal de confirma√ß√£o
    var master = document.getElementById('bulk-master');
    var bar = document.getElementById('bulk-action-bar');
    var countEl = document.getElementById('bulk-action-count');
    var barCancel = document.getElementById('bulk-action-cancel');
    var barConfirm = document.getElementById('bulk-action-confirm');
    var modalBackdrop = document.getElementById('modal-bulk-delete-backdrop');
    var modalEl = document.getElementById('modal-bulk-delete');
    var modalMsg = document.getElementById('modal-bulk-delete-msg');
    var modalCancel = document.getElementById('modal-bulk-delete-cancel');
    var modalOk = document.getElementById('modal-bulk-delete-ok');

    function fmtMoeda(v) {
        if (v == null || isNaN(v)) return 'R$ 0,00';
        return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(v);
    }

    function getRowChecks() {
        return document.querySelectorAll('#vendas-tbody .bulk-row-check');
    }

    function updateBar() {
        var checks = getRowChecks();
        var n = 0;
        for (var i = 0; i < checks.length; i++) { if (checks[i].checked) n++; }
        if (n > 0) {
            bar.classList.remove('hidden');
            countEl.textContent = n + ' itens selecionados';
        } else {
            bar.classList.add('hidden');
        }
        if (master) {
            master.checked = n === checks.length && checks.length > 0;
            master.indeterminate = n > 0 && n < checks.length;
        }
    }

    if (master) {
        master.addEventListener('change', function() {
            var checks = getRowChecks();
            var on = this.checked;
            checks.forEach(function(c) { c.checked = on; });
            updateBar();
        });
    }

    document.getElementById('vendas-tbody').addEventListener('change', function(e) {
        if (e.target.classList.contains('bulk-row-check')) {
            updateBar();
        }
    });

    if (barCancel) {
        barCancel.addEventListener('click', function() {
            getRowChecks().forEach(function(c) { c.checked = false; });
            if (master) { master.checked = false; master.indeterminate = false; }
            bar.classList.add('hidden');
        });
    }

    if (barConfirm) {
        barConfirm.addEventListener('click', function() {
            var checks = getRowChecks();
            var ids = [];
            var lucroTotal = 0;
            for (var i = 0; i < checks.length; i++) {
                if (!checks[i].checked) continue;
                var raw = checks[i].getAttribute('data-venda-ids');
                var arr = [];
                try { arr = JSON.parse(raw || '[]'); } catch (_) {}
                for (var j = 0; j < arr.length; j++) { ids.push(arr[j]); }
                var lt = parseFloat(checks[i].getAttribute('data-lucro-total') || '0');
                if (!isNaN(lt)) lucroTotal += lt;
            }
            if (ids.length === 0) {
                bar.classList.add('hidden');
                return;
            }
            modalMsg.textContent = 'Tem certeza? Esta a√ß√£o remover√° ' + ids.length + ' registros permanentemente e afetar√° o Lucro Total de ' + fmtMoeda(lucroTotal) + '.';
            modalBackdrop.classList.remove('hidden');
            modalEl.classList.remove('hidden');
            modalEl.dataset.pendingIds = JSON.stringify(ids);
        });
    }

    function closeBulkModal() {
        modalBackdrop.classList.add('hidden');
        modalEl.classList.add('hidden');
        delete modalEl.dataset.pendingIds;
    }

    if (modalCancel) modalCancel.addEventListener('click', closeBulkModal);
    if (modalBackdrop) modalBackdrop.addEventListener('click', closeBulkModal);

    if (modalOk) {
        modalOk.addEventListener('click', function() {
            var raw = modalEl.dataset.pendingIds;
            if (!raw) { closeBulkModal(); return; }
            var ids = [];
            try { ids = JSON.parse(raw); } catch (_) {}
            if (ids.length === 0) { closeBulkModal(); return; }
            modalOk.disabled = true;
            fetch('{{ url_for("vendas_deletar_massa") }}', {
                method: 'POST',
                headers: Object.assign({ 'Content-Type': 'application/json', 'X-Requested-With': 'XMLHttpRequest' }, window.getCsrfHeaders ? window.getCsrfHeaders() : {}),
                body: JSON.stringify({ ids: ids })
            }).then(function(r) { return r.json(); }).then(function(data) {
                if (data.ok) {
                    try { sessionStorage.setItem('bulkDeleteSuccess', data.mensagem || ''); } catch (_) {}
                    window.location.href = '{{ url_for("listar_vendas") }}';
                    return;
                }
                alert(data.mensagem || 'Erro ao excluir.');
                modalOk.disabled = false;
            }).catch(function() {
                alert('Erro ao excluir. Tente novamente.');
                modalOk.disabled = false;
            });
        });
    }

    var bulkMsg = null;
    try { bulkMsg = sessionStorage.getItem('bulkDeleteSuccess'); sessionStorage.removeItem('bulkDeleteSuccess'); } catch (_) {}
    if (bulkMsg) {
        var toast = document.getElementById('bulk-delete-toast');
        var toastSpan = document.getElementById('bulk-delete-toast-msg');
        if (toast && toastSpan) {
            toastSpan.textContent = bulkMsg;
            toast.classList.remove('hidden');
            if (typeof lucide !== 'undefined') lucide.createIcons();
            setTimeout(function() { toast.classList.add('hidden'); }, 6000);
        }
    }
})();

(function() {
    // Fun√ß√£o helper para formatar moeda brasileira
    function formatoMoeda(valor) {
        if (valor === null || valor === undefined || isNaN(valor)) return 'R$ 0,00';
        return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(valor);
    }

    // M√°scara de moeda: formata n√∫mero para "R$ X.XXX,XX"
    function formatPreco(valor) {
        if (valor === null || valor === undefined || isNaN(valor)) return 'R$ 0,00';
        return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(valor);
    }

    // Remove "R$", espa√ßos, pontos de milhar; troca v√≠rgula por ponto; retorna n√∫mero.
    function parsePreco(str) {
        if (!str || typeof str !== 'string') return 0;
        var s = str.replace(/\s/g, '').replace(/R\$/gi, '').replace(/\./g, '').replace(',', '.');
        var n = parseFloat(s);
        return isNaN(n) ? 0 : n;
    }

    var form = document.getElementById('form-nova-venda-inline');
    var erroDiv = document.getElementById('venda-erro');
    var btnAdicionar = document.getElementById('btn-adicionar-carrinho');
    var produtoSelect = document.getElementById('inline-produto_id');
    var clienteSelect = document.getElementById('inline-cliente_id');
    var precoInput = document.getElementById('preco');
    var quantidadeInput = document.getElementById('inline-quantidade_venda');
    var estoqueInfo = document.getElementById('inline-estoque-info');
    var dataInput = document.getElementById('inline-data_venda');
    var carrinhoVazio = document.getElementById('carrinho-vazio');
    var carrinhoTabelaWrap = document.getElementById('carrinho-tabela-wrap');
    var carrinhoTbody = document.getElementById('carrinho-tbody');
    var carrinhoAcoes = document.getElementById('carrinho-acoes');
    var btnFinalizar = document.getElementById('btn-finalizar-carrinho');
    var btnLimpar = document.getElementById('btn-limpar-carrinho');
    var carrinhoWrap = document.getElementById('carrinho-wrap');
    var processarUrl = carrinhoWrap ? carrinhoWrap.getAttribute('data-processar-url') : '/processar_carrinho';

    var carrinho = [];
    var precoCustoSugerido = 0;
    var precoProgrammatic = false;

    function hideErro() {
        if (erroDiv) { erroDiv.classList.add('hidden'); erroDiv.textContent = ''; }
    }

    function showErro(msg) {
        if (!erroDiv) return;
        erroDiv.textContent = msg;
        erroDiv.classList.remove('hidden');
    }

    function resetForm() {
        if (!form) return;
        if (window.vendasClienteSearch && window.vendasClienteSearch.destroy) window.vendasClienteSearch.destroy();
        form.reset();
        if (quantidadeInput) quantidadeInput.value = '1';
        if (dataInput) dataInput.value = new Date().toISOString().split('T')[0];
        precoClearAndResetSuggestion();
        if (estoqueInfo) { estoqueInfo.textContent = ''; estoqueInfo.className = 'mt-0.5 text-xs text-gray-500 dark:text-gray-400'; }
        updateValorTotalDisplay();
        if (btnAdicionar) btnAdicionar.disabled = false;
        hideErro();
        if (window.vendasClienteSearch && window.vendasClienteSearch.init) window.vendasClienteSearch.init();
        if (typeof lucide !== 'undefined') lucide.createIcons();
    }

    function precoClearAndResetSuggestion() {
        precoCustoSugerido = 0;
        if (precoInput) {
            precoInput.value = '';
            precoInput.classList.remove('preco-sugerido');
        }
        updateValorTotalDisplay();
    }

    /** Atualiza o campo Valor Total com Pre√ßo √ó Quantidade (somente exibi√ß√£o). */
    function updateValorTotalDisplay() {
        var valorTotalEl = document.getElementById('inline-valor-total');
        if (!valorTotalEl) return;
        var qtd = parseInt(quantidadeInput && quantidadeInput.value ? quantidadeInput.value : '0', 10);
        var preco = parsePreco(precoInput && precoInput.value ? precoInput.value : '') || 0;
        var total = (qtd >= 1 && preco > 0) ? preco * qtd : 0;
        valorTotalEl.value = formatPreco(total);
    }

    /** Limpa apenas Produto, Quantidade e Pre√ßo. Mant√©m Cliente, NF, Data, Empresa e Situa√ß√£o. N√£o mexe no Tom Select. Foco em Produto. */
    function resetFormParaProximoItem() {
        if (!form) return;
        hideErro();
        if (estoqueInfo) { estoqueInfo.textContent = ''; estoqueInfo.className = 'mt-0.5 text-xs text-gray-500 dark:text-gray-400'; }
        if (produtoSelect) {
            produtoSelect.value = '';
            setTimeout(function() { produtoSelect.focus(); }, 0);
        }
        if (quantidadeInput) quantidadeInput.value = '1';
        precoClearAndResetSuggestion();
        updateValorTotalDisplay();
        if (typeof lucide !== 'undefined') lucide.createIcons();
    }

    function buildItemFromForm() {
        var cid = (clienteSelect && clienteSelect.value) ? clienteSelect.value.trim() : '';
        var pid = (produtoSelect && produtoSelect.value) ? produtoSelect.value.trim() : '';
        var optCliente = clienteSelect && clienteSelect.selectedIndex >= 0 ? clienteSelect.options[clienteSelect.selectedIndex] : null;
        var optProduto = produtoSelect && produtoSelect.selectedIndex >= 0 ? produtoSelect.options[produtoSelect.selectedIndex] : null;
        var cliente_nome = optCliente ? optCliente.text : '';
        var produto_nome = optProduto ? optProduto.text : '';
        var preco_custo = 0;
        if (optProduto) {
            var pc = parseFloat(optProduto.getAttribute('data-preco') || '0');
            if (!isNaN(pc)) preco_custo = pc;
        }
        var nf = (form.querySelector('[name="nf"]') && form.querySelector('[name="nf"]').value) ? form.querySelector('[name="nf"]').value.trim() : '';
        var qtd = parseInt(quantidadeInput && quantidadeInput.value ? quantidadeInput.value : '0', 10);
        var preco = parsePreco(precoInput && precoInput.value ? precoInput.value : '') || 0;
        var dataVal = dataInput && dataInput.value ? dataInput.value.trim() : '';
        if (!dataVal) dataVal = new Date().toISOString().split('T')[0];
        var empresa = (form.querySelector('[name="empresa_faturadora"]') && form.querySelector('[name="empresa_faturadora"]').value) || '';
        var situacao = (form.querySelector('[name="situacao"]') && form.querySelector('[name="situacao"]').value) || 'PENDENTE';
        var formaPagEl = document.getElementById('inline-forma_pagamento');
        var formaPagamento = (formaPagEl && formaPagEl.value) ? String(formaPagEl.value).trim() : '';
        if (!cid || !pid) return null;
        if (qtd < 1 || preco <= 0 || !empresa) return null;
        var total = preco * qtd;
        var lucro = (preco - preco_custo) * qtd;
        return {
            cliente_id: parseInt(cid, 10),
            cliente_nome: cliente_nome,
            produto_id: parseInt(pid, 10),
            produto_nome: produto_nome,
            nf: nf || null,
            quantidade_venda: qtd,
            preco_venda: preco,
            preco_custo: preco_custo,
            total: total,
            lucro: lucro,
            data_venda: dataVal,
            empresa_faturadora: empresa,
            situacao: situacao,
            forma_pagamento: formaPagamento || null
        };
    }

    function renderCart() {
        if (!carrinhoTbody) return;
        if (carrinho.length === 0) {
            if (carrinhoVazio) carrinhoVazio.classList.remove('hidden');
            if (carrinhoTabelaWrap) carrinhoTabelaWrap.classList.add('hidden');
            if (carrinhoAcoes) carrinhoAcoes.classList.add('hidden');
            if (typeof lucide !== 'undefined') lucide.createIcons();
            return;
        }
        if (carrinhoVazio) carrinhoVazio.classList.add('hidden');
        if (carrinhoTabelaWrap) carrinhoTabelaWrap.classList.remove('hidden');
        if (carrinhoAcoes) carrinhoAcoes.classList.remove('hidden');
        carrinhoTbody.innerHTML = '';
        var totalBruto = 0;
        var lucroTotal = 0;
        for (var i = 0; i < carrinho.length; i++) {
            var it = carrinho[i];
            totalBruto += it.total;
            lucroTotal += typeof it.lucro === 'number' ? it.lucro : 0;
            var tr = document.createElement('tr');
            tr.className = 'hover:bg-emerald-50/60 dark:hover:bg-emerald-900/30 transition';
            var precoStr = formatoMoeda(it.preco_venda);
            var totalStr = formatoMoeda(it.total);
            var lucro = typeof it.lucro === 'number' ? it.lucro : 0;
            var lucroStr = formatoMoeda(lucro);
            var lucroClass = lucro > 0 ? 'text-emerald-600 dark:text-emerald-400 font-medium' : (lucro < 0 ? 'text-red-600 dark:text-red-400 font-semibold' : 'text-amber-600 dark:text-amber-400 font-medium');
            var formaPagStr = (it.forma_pagamento && it.forma_pagamento.trim()) ? it.forma_pagamento : '-';
            tr.innerHTML =
                '<td class="px-4 py-2 text-sm font-medium text-gray-900 dark:text-gray-100">' + (it.cliente_nome || '-') + '</td>' +
                '<td class="px-4 py-2 text-sm text-gray-900 dark:text-gray-100">' + (it.produto_nome || '-') + '</td>' +
                '<td class="px-4 py-2 text-sm text-gray-900 dark:text-gray-100">' + (it.nf || '-') + '</td>' +
                '<td class="px-4 py-2 text-sm text-gray-900 dark:text-gray-100 text-right">' + it.quantidade_venda + '</td>' +
                '<td class="px-4 py-2 text-sm text-gray-900 dark:text-gray-100 text-right">' + precoStr + '</td>' +
                '<td class="px-4 py-2 text-sm text-right ' + lucroClass + '">' + lucroStr + '</td>' +
                '<td class="px-4 py-2 text-sm font-bold text-gray-900 dark:text-gray-100 text-right">' + totalStr + '</td>' +
                '<td class="px-4 py-2 text-sm text-gray-900 dark:text-gray-100"><span class="px-2 py-0.5 text-xs rounded ' + (formaPagStr !== '-' ? 'bg-blue-100 dark:bg-blue-900/40 text-blue-800 dark:text-blue-300' : 'text-gray-400 dark:text-gray-500') + '">' + formaPagStr + '</span></td>' +
                '<td class="px-4 py-2 text-right"><button type="button" class="carrinho-remover text-red-600 dark:text-red-400 hover:text-red-800 dark:hover:text-red-300 inline-flex p-1 rounded hover:bg-red-50 dark:hover:bg-red-900/30" data-index="' + i + '" title="Remover do carrinho"><i data-lucide="trash-2" class="w-4 h-4"></i></button></td>';
            carrinhoTbody.appendChild(tr);
        }
        var brutoEl = document.getElementById('carrinho-total-bruto');
        var lucroEl = document.getElementById('carrinho-lucro-estimado');
        if (brutoEl) brutoEl.textContent = formatoMoeda(totalBruto);
        if (lucroEl) {
            lucroEl.textContent = formatoMoeda(lucroTotal);
            lucroEl.className = lucroTotal > 0 ? 'text-emerald-600 dark:text-emerald-400 font-bold' : (lucroTotal < 0 ? 'text-red-600 dark:text-red-400 font-bold' : 'text-amber-600 dark:text-amber-400 font-bold');
        }
        if (typeof lucide !== 'undefined') lucide.createIcons();

        var removes = carrinhoTbody.querySelectorAll('.carrinho-remover');
        for (var r = 0; r < removes.length; r++) {
            removes[r].addEventListener('click', function() {
                var idx = parseInt(this.getAttribute('data-index'), 10);
                if (isNaN(idx) || idx < 0 || idx >= carrinho.length) return;
                carrinho.splice(idx, 1);
                renderCart();
            });
        }
    }

    function itensParaBackend() {
        return carrinho.map(function(it) {
            return {
                cliente_id: it.cliente_id,
                produto_id: it.produto_id,
                nf: it.nf,
                quantidade_venda: it.quantidade_venda,
                preco_venda: it.preco_venda,
                data_venda: it.data_venda,
                empresa_faturadora: it.empresa_faturadora,
                situacao: it.situacao,
                forma_pagamento: it.forma_pagamento || null
            };
        });
    }

    if (dataInput && !dataInput.value) dataInput.value = new Date().toISOString().split('T')[0];

    if (produtoSelect) {
        produtoSelect.addEventListener('change', function() {
            var opt = this.options[this.selectedIndex];
            if (!opt || !opt.value) {
                estoqueInfo.textContent = '';
                precoClearAndResetSuggestion();
                return;
            }
            var estoque = opt.getAttribute('data-estoque');
            var preco = opt.getAttribute('data-preco');
            if (estoque != null) {
                estoqueInfo.textContent = 'Est.: ' + estoque;
                estoqueInfo.className = 'mt-0.5 text-xs ' + (parseInt(estoque, 10) > 0 ? 'text-emerald-600 dark:text-emerald-400' : 'text-red-600 dark:text-red-400');
                if (preco && precoInput) {
                    var pc = parseFloat(preco);
                    if (!isNaN(pc)) {
                        var isEmpty = !precoInput.value || parsePreco(precoInput.value) === 0;
                        if (isEmpty) {
                            precoProgrammatic = true;
                            precoInput.value = formatPreco(pc);
                            precoInput.classList.add('preco-sugerido');
                            precoCustoSugerido = pc;
                            precoProgrammatic = false;
                            updateValorTotalDisplay();
                        }
                    }
                }
            } else {
                estoqueInfo.textContent = '';
            }
        });
    }

    if (precoInput) {
        precoInput.addEventListener('input', function() {
            if (precoProgrammatic) return;
            var raw = (this.value || '').replace(/\D/g, '');
            if (raw === '') {
                this.value = '';
                return;
            }
            var num = parseInt(raw, 10) / 100;
            this.value = formatPreco(num);
            this.classList.remove('preco-sugerido');
            updateValorTotalDisplay();
        });
        precoInput.addEventListener('focus', function() {
            if (this.classList.contains('preco-sugerido')) {
                precoProgrammatic = true;
                this.value = '';
                this.classList.remove('preco-sugerido');
                precoProgrammatic = false;
            }
        });
        precoInput.addEventListener('blur', function() {
            var v = (this.value || '').trim();
            if (v === '' && precoCustoSugerido > 0) {
                precoProgrammatic = true;
                this.value = formatPreco(precoCustoSugerido);
                this.classList.add('preco-sugerido');
                precoProgrammatic = false;
            }
            updateValorTotalDisplay();
        });
    }
    if (quantidadeInput && produtoSelect) {
        quantidadeInput.addEventListener('input', function() {
            var opt = produtoSelect.options[produtoSelect.selectedIndex];
            var est = parseInt(opt.getAttribute('data-estoque') || '0', 10);
            var q = parseInt(this.value || '0', 10);
            if (est > 0 && q > est) {
                estoqueInfo.textContent = 'Est. insuficiente! Disp.: ' + est;
                estoqueInfo.className = 'mt-0.5 text-xs text-red-600 dark:text-red-400 font-semibold';
            } else if (est > 0) {
                estoqueInfo.textContent = 'Est.: ' + est;
                estoqueInfo.className = 'mt-0.5 text-xs text-emerald-600';
            }
            updateValorTotalDisplay();
        });
    }
    if (quantidadeInput) {
        quantidadeInput.addEventListener('input', updateValorTotalDisplay);
    }

    if (form) {
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            hideErro();
            var it = buildItemFromForm();
            if (!it) {
                showErro('Preencha Cliente, Produto, Quantidade, Pre√ßo e Empresa.');
                return;
            }
            carrinho.push(it);
            resetFormParaProximoItem();
            renderCart();
        });
    }

    if (btnLimpar) {
        btnLimpar.addEventListener('click', function() {
            carrinho = [];
            renderCart();
            hideErro();
        });
    }

    if (btnFinalizar) {
        btnFinalizar.addEventListener('click', function() {
            if (carrinho.length === 0) {
                showErro('Carrinho vazio. Adicione itens antes de finalizar.');
                return;
            }
            hideErro();
            btnFinalizar.disabled = true;
            var payload = { itens: itensParaBackend() };
            fetch(processarUrl, {
                method: 'POST',
                headers: Object.assign({ 'Content-Type': 'application/json', 'X-Requested-With': 'XMLHttpRequest' }, window.getCsrfHeaders ? window.getCsrfHeaders() : {}),
                body: JSON.stringify(payload)
            })
                .then(function(r) { return r.json().then(function(j) { return { status: r.status, json: j }; }); })
                .then(function(x) {
                    if (x.json.ok) {
                        carrinho = [];
                        renderCart();
                        alert(x.json.mensagem || 'Vendas registradas com sucesso.');
                        window.location.reload();
                        return;
                    }
                    showErro(x.json.mensagem || 'Erro ao processar carrinho.');
                    btnFinalizar.disabled = false;
                })
                .catch(function() {
                    showErro('Erro ao processar carrinho. Tente novamente.');
                    btnFinalizar.disabled = false;
                });
        });
    }
    updateValorTotalDisplay();
})();
</script>

<script src="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/js/tom-select.complete.min.js"></script>
<script>
(function() {
    var form = document.getElementById('form-nova-venda-inline');
    var clienteSelectEl = document.getElementById('inline-cliente_id');
    var produtoSelectEl = document.getElementById('inline-produto_id');
    var tomSelectCliente = null;

    function initClienteSearch() {
        if (!clienteSelectEl) return;
        if (tomSelectCliente) {
            try { tomSelectCliente.destroy(); } catch (e) {}
            tomSelectCliente = null;
        }
        tomSelectCliente = new TomSelect('#inline-cliente_id', {
            placeholder: 'Digite o nome do cliente...',
            maxOptions: null,
            dropdownParent: 'body',
            render: {
                no_results: function(data, escape) {
                    return '<div class="no-results">Cliente n√£o encontrado</div>';
                }
            },
            onItemAdd: function(value) {
                var wrap = document.querySelector('#cliente-select-wrap .ts-wrapper');
                if (wrap) wrap.classList.add('campo-preenchido');
                if (produtoSelectEl) setTimeout(function() { produtoSelectEl.focus(); }, 80);
                // Auto-preenchimento da Forma de Pagamento com base na √∫ltima compra do cliente
                if (value) {
                    fetch('/api/cliente/ultimo_pagamento?cliente_id=' + encodeURIComponent(value))
                        .then(function(r) { return r.json(); })
                        .then(function(data) {
                            if (data.forma_pagamento) {
                                var selectPag = document.getElementById('inline-forma_pagamento');
                                if (selectPag) {
                                    var norm = function(s) { return (s || '').toString().normalize('NFD').replace(/[\u0300-\u036f]/g, '').toUpperCase().trim(); };
                                    var fpNorm = norm(data.forma_pagamento);
                                    for (var i = 0; i < selectPag.options.length; i++) {
                                        var opt = selectPag.options[i];
                                        if (opt.value && norm(opt.value) === fpNorm) {
                                            selectPag.value = opt.value;
                                            selectPag.classList.add('ring-2', 'ring-emerald-500', 'transition-all');
                                            setTimeout(function() { selectPag.classList.remove('ring-2', 'ring-emerald-500'); }, 1000);
                                            break;
                                        }
                                    }
                                }
                            }
                        })
                        .catch(function(err) { console.error('Erro ao buscar pagamento padr√£o:', err); });
                }
            },
            onClear: function() {
                var wrap = document.querySelector('#cliente-select-wrap .ts-wrapper');
                if (wrap) wrap.classList.remove('campo-preenchido');
            },
            onDropdownOpen: function(dropdown) {
                if (dropdown) dropdown.classList.add('vendas-cliente-dropdown');
            }
        });
    }

    function destroyClienteSearch() {
        if (tomSelectCliente) {
            try { tomSelectCliente.destroy(); } catch (e) {}
            tomSelectCliente = null;
        }
    }

    if (typeof TomSelect !== 'undefined' && clienteSelectEl) {
        initClienteSearch();
    }

    window.vendasClienteSearch = { init: initClienteSearch, destroy: destroyClienteSearch };
    
    // Preenchimento autom√°tico do formul√°rio a partir de par√¢metros da URL (vindos do Dashboard)
    function preencherFormularioDeURL() {
        try {
            var urlParams = new URLSearchParams(window.location.search);
            var clienteNome = urlParams.get('cliente');
            var nf = urlParams.get('nf');
            var data = urlParams.get('data');
            
            // Preencher NF se fornecida
            if (nf) {
                var nfInput = document.getElementById('inline-nf');
                if (nfInput) {
                    nfInput.value = nf;
                    console.log('NF preenchida automaticamente:', nf);
                }
            }
            
            // Preencher Data se fornecida
            if (data) {
                var dataInput = document.getElementById('inline-data_venda');
                if (dataInput) {
                    dataInput.value = data;
                    console.log('Data preenchida automaticamente:', data);
                }
            }
            
            // Fun√ß√£o auxiliar: normalizar string (lowercase, remove acentos, espa√ßos extras, pontua√ß√£o)
            function normalizar(str) {
                if (!str) return '';
                return str
                    .toLowerCase()
                    .normalize('NFD').replace(/[\u0300-\u036f]/g, '') // Remove acentos
                    .replace(/[^\w\s]/g, '') // Remove pontua√ß√£o
                    .replace(/\s+/g, ' ') // Normaliza espa√ßos
                    .trim();
            }
            
            // Preencher Cliente se fornecido
            if (clienteNome && tomSelectCliente) {
                var clienteEncontrado = false;
                var options = tomSelectCliente.options;
                var clienteNomeNorm = normalizar(clienteNome);
                
                console.log('Buscando cliente:', clienteNome, '(normalizado:', clienteNomeNorm + ')');
                
                var melhorMatch = null;
                var melhorScore = 0;
                
                // Buscar melhor correspond√™ncia (exata > parcial > palavras-chave)
                for (var key in options) {
                    if (options.hasOwnProperty(key) && key !== '') {
                        var optionText = options[key].text || '';
                        var optionValue = options[key].value || '';
                        var optionTextNorm = normalizar(optionText);
                        var optionValueNorm = normalizar(optionValue);
                        
                        var score = 0;
                        
                        // Match exato (normalizado)
                        if (optionTextNorm === clienteNomeNorm || optionValueNorm === clienteNomeNorm) {
                            score = 100;
                        }
                        // Match parcial: texto da op√ß√£o cont√©m o nome buscado
                        else if (optionTextNorm.indexOf(clienteNomeNorm) !== -1) {
                            score = 80;
                        }
                        // Match parcial: nome buscado cont√©m o texto da op√ß√£o
                        else if (clienteNomeNorm.indexOf(optionTextNorm) !== -1) {
                            score = 70;
                        }
                        // Match por palavras-chave (todas as palavras do nome buscado aparecem na op√ß√£o)
                        else {
                            var palavrasBusca = clienteNomeNorm.split(' ').filter(function(p) { return p.length > 2; });
                            var palavrasOpcao = optionTextNorm.split(' ');
                            var palavrasEncontradas = 0;
                            
                            palavrasBusca.forEach(function(palavra) {
                                if (palavrasOpcao.some(function(p) { return p.indexOf(palavra) !== -1; })) {
                                    palavrasEncontradas++;
                                }
                            });
                            
                            if (palavrasEncontradas > 0 && palavrasBusca.length > 0) {
                                score = Math.floor((palavrasEncontradas / palavrasBusca.length) * 60);
                            }
                        }
                        
                        if (score > melhorScore) {
                            melhorScore = score;
                            melhorMatch = { key: key, text: optionText, score: score };
                        }
                    }
                }
                
                // Selecionar se o score for razo√°vel (>= 60%)
                if (melhorMatch && melhorScore >= 60) {
                    tomSelectCliente.setValue(melhorMatch.key);
                    clienteEncontrado = true;
                    console.log('‚úì Cliente selecionado:', melhorMatch.text, '(score:', melhorScore + ')');
                    
                    // Disparar evento change para atualizar depend√™ncias
                    var event = new Event('change', { bubbles: true });
                    clienteSelectEl.dispatchEvent(event);
                } else {
                    console.warn('‚úó Cliente "' + clienteNome + '" n√£o encontrado (melhor match: score ' + melhorScore + ')');
                }
                
                // Se n√£o encontrou, exibir mensagem amig√°vel
                if (!clienteEncontrado) {
                    var erroDiv = document.getElementById('venda-erro');
                    if (erroDiv) {
                        erroDiv.textContent = 'Cliente "' + clienteNome + '" n√£o encontrado no cadastro. Selecione manualmente ou cadastre o cliente.';
                        erroDiv.classList.remove('hidden');
                        setTimeout(function() {
                            erroDiv.classList.add('hidden');
                        }, 8000);
                    }
                }
            }
            
            // Limpar par√¢metros da URL ap√≥s preencher (para n√£o repetir ao recarregar)
            if (clienteNome || nf || data) {
                var newUrl = window.location.pathname;
                window.history.replaceState({}, document.title, newUrl);
            }
        } catch (e) {
            console.error('Erro ao preencher formul√°rio de URL:', e);
        }
    }
    
    // Executar ap√≥s TomSelect estar pronto
    if (tomSelectCliente) {
        setTimeout(preencherFormularioDeURL, 300);
    }
})();

// Fluxo PDV: feedback visual (.campo-preenchido) + auto-focus em Cliente -> Produto -> NF -> Qtd -> Pre√ßo -> Bot√£o
(function() {
    var produtoSelect = document.getElementById('inline-produto_id');
    var nfInput = document.getElementById('inline-nf');
    var quantidadeInput = document.getElementById('inline-quantidade_venda');
    var precoInput = document.getElementById('preco');
    var btnAdicionar = document.getElementById('btn-adicionar-carrinho');
    var form = document.getElementById('form-nova-venda-inline');
    var clienteWrap = document.querySelector('#cliente-select-wrap .ts-wrapper');

    function toggleCampoPreenchido(el, hasValue) {
        if (!el) return;
        if (hasValue) el.classList.add('campo-preenchido');
        else el.classList.remove('campo-preenchido');
    }

    function updateClienteCampoPreenchido() {
        if (!clienteWrap) return;
        var select = document.getElementById('inline-cliente_id');
        var val = (select && select.value) || '';
        if (val) clienteWrap.classList.add('campo-preenchido');
        else clienteWrap.classList.remove('campo-preenchido');
    }

    // Produto: change -> add class, focus NF
    if (produtoSelect) {
        produtoSelect.addEventListener('change', function() {
            toggleCampoPreenchido(this, !!this.value);
            if (this.value && nfInput) {
                nfInput.focus();
            }
        });
    }

    // NF: input -> toggle class; keydown Enter -> focus Quantidade
    if (nfInput) {
        nfInput.addEventListener('input', function() { toggleCampoPreenchido(this, !!this.value.trim()); });
        nfInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                if (quantidadeInput) quantidadeInput.focus();
            }
        });
    }

    // Quantidade: input -> toggle class; keydown Enter -> focus Pre√ßo
    if (quantidadeInput) {
        quantidadeInput.addEventListener('input', function() { toggleCampoPreenchido(this, !!this.value); });
        quantidadeInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                if (precoInput) precoInput.focus();
            }
        });
    }

    // Pre√ßo: input -> toggle class; keydown Enter -> submit form (Adicionar ao Carrinho)
    if (precoInput) {
        precoInput.addEventListener('input', function() {
            var raw = (this.value || '').replace(/\D/g, '');
            toggleCampoPreenchido(this, raw.length > 0);
        });
        precoInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                if (form && btnAdicionar) {
                    form.requestSubmit(btnAdicionar);
                }
            }
        });
    }

    // Marcar Cliente como preenchido se vier preenchido da URL
    if (clienteWrap) {
        setTimeout(updateClienteCampoPreenchido, 400);
    }

    // Marcar Produto como preenchido se tiver valor ao carregar
    if (produtoSelect && produtoSelect.value) {
        produtoSelect.classList.add('campo-preenchido');
    }
})();
</script>

<!-- Script de Pagina√ß√£o Scroll Infinito -->
<script>
(function() {
    var sentinela = document.getElementById('sentinela-scroll');
    var tbody = document.getElementById('vendas-tbody');
    var paginaAtual = {{ pagination.page if pagination else 1 }};
    var carregando = false;
    var fimDaLista = false;
    
    if (!sentinela || !tbody) return;
    
    var viewGrade = document.getElementById('view-grade');
    var observer = null;

    function carregarMaisVendas() {
        if (carregando || fimDaLista) return Promise.resolve();
        
        carregando = true;
        
        var urlParams = new URLSearchParams(window.location.search);
        urlParams.set('page', paginaAtual + 1);
        urlParams.set('ajax', '1');
        var url = '{{ url_for("listar_vendas") }}?' + urlParams.toString();
        
        return fetch(url, {
            method: 'GET',
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
        })
        .then(function(response) {
            if (!response.ok) throw new Error('Erro ao carregar vendas');
            return response.json();
        })
        .then(function(data) {
            var rowsHtml = (data && data.rows) ? data.rows.trim() : '';
            var cardsHtml = (data && data.cards) ? data.cards.trim() : '';
            if (!rowsHtml && !cardsHtml) {
                pararScroll();
                return;
            }
            
            var linhasAntes = tbody.querySelectorAll('tr.pedido-resumo').length;
            
            if (rowsHtml) {
                tbody.insertAdjacentHTML('beforeend', rowsHtml);
            }
            
            if (cardsHtml && viewGrade) {
                var emptyDiv = viewGrade.querySelector('.col-span-full');
                if (emptyDiv) emptyDiv.remove();
                var cardsAntes = viewGrade.querySelectorAll('.btn-editar-venda').length;
                viewGrade.insertAdjacentHTML('beforeend', cardsHtml);
                var todosCardsBtn = viewGrade.querySelectorAll('.btn-editar-venda');
                Array.from(todosCardsBtn).slice(cardsAntes).forEach(function(btn) {
                    if (!btn.hasAttribute('data-pagination-initialized')) {
                        btn.setAttribute('data-pagination-initialized', 'true');
                        btn.addEventListener('click', function() {
                            abrirModalEditarVenda(btn);
                        });
                    }
                });
            }
            
            var linhasDepois = tbody.querySelectorAll('tr.pedido-resumo').length;
            var pedidosCarregados = linhasDepois - linhasAntes;
            
            if (pedidosCarregados === 0) {
                pararScroll();
                return;
            }
            
            paginaAtual++;
            
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
            
            initAccordion();
            
            var todasLinhas = tbody.querySelectorAll('tr.pedido-resumo');
            Array.from(todasLinhas).slice(linhasAntes).forEach(function(linhaResumo) {
                var linhaDetalhes = tbody.querySelector('tr.pedido-detalhes[data-pedido-id="' + linhaResumo.getAttribute('data-pedido-id') + '"]');
                if (linhaDetalhes) {
                    var botoesEditar = linhaDetalhes.querySelectorAll('.btn-editar-venda');
                    botoesEditar.forEach(function(btn) {
                        if (!btn.hasAttribute('data-pagination-initialized')) {
                            btn.setAttribute('data-pagination-initialized', 'true');
                            btn.addEventListener('click', function() {
                                abrirModalEditarVenda(btn);
                            });
                        }
                    });
                }
            });
            
            if (pedidosCarregados < 20) {
                pararScroll();
            }
            
            carregando = false;
        })
        .catch(function(error) {
            console.error('Erro ao carregar mais vendas:', error);
            carregando = false;
        });
    }

    function pararScroll() {
        fimDaLista = true;
        carregando = false;
        if (observer) observer.disconnect();
        if (sentinela) sentinela.remove();
    }

    observer = new IntersectionObserver(function(entries) {
        if (entries[0].isIntersecting && !carregando && !fimDaLista) {
            carregarMaisVendas();
        }
    }, {
        rootMargin: '300px',
        threshold: 0.1
    });
    observer.observe(sentinela);
    
    // Fun√ß√£o para inicializar accordion (reutilizar a fun√ß√£o existente)
    function initAccordion() {
        var linhasResumo = document.querySelectorAll('.pedido-resumo');
        linhasResumo.forEach(function(linha) {
            // Verificar se j√° tem listener
            if (linha.hasAttribute('data-accordion-initialized')) return;
            linha.setAttribute('data-accordion-initialized', 'true');
            
            linha.addEventListener('click', function(e) {
                // N√£o expandir se clicar em a√ß√µes, formul√°rios ou checkbox de bulk
                if (e.target.closest('a, button, form, input')) {
                    return;
                }
                
                var pedidoId = linha.getAttribute('data-pedido-id');
                var detalhes = document.querySelector('.pedido-detalhes[data-pedido-id="' + pedidoId + '"]');
                var chevron = linha.querySelector('.pedido-chevron');
                
                if (detalhes) {
                    var isHidden = detalhes.classList.contains('hidden');
                    
                    if (isHidden) {
                        // Expandir
                        detalhes.classList.remove('hidden');
                        if (chevron) {
                            chevron.style.transform = 'rotate(180deg)';
                        }
                    } else {
                        // Colapsar
                        detalhes.classList.add('hidden');
                        if (chevron) {
                            chevron.style.transform = 'rotate(0deg)';
                        }
                    }
                    
                    // Atualizar √≠cones Lucide ap√≥s mudan√ßa
                    if (typeof lucide !== 'undefined') {
                        lucide.createIcons();
                    }
                }
            });
        });
    }
    
    // Fun√ß√£o para abrir modal de editar venda (reutilizar a fun√ß√£o existente)
    function abrirModalEditarVenda(btn) {
        var wrap = document.getElementById('modal-editar-venda-wrap');
        var form = document.getElementById('form-editar-venda');
        if (!wrap || !form) return;
        
        var actionBase = form.getAttribute('data-action-base') || '';
        var id = btn.getAttribute('data-id');
        var clienteId = btn.getAttribute('data-cliente-id') || '';
        var produtoId = btn.getAttribute('data-produto-id') || '';
        var qtd = btn.getAttribute('data-qtd') || '1';
        var preco = btn.getAttribute('data-preco') || '';
        var nf = btn.getAttribute('data-nf') || '';
        var data = btn.getAttribute('data-data') || '';
        var empresa = btn.getAttribute('data-empresa') || '';
        var situacao = btn.getAttribute('data-situacao') || 'PENDENTE';
        var formaPagamento = btn.getAttribute('data-forma-pagamento') || '';

        form.action = actionBase.replace(/\/0$/, '/') + id;
        document.getElementById('edit_cliente_id').value = clienteId;
        document.getElementById('edit_produto_id').value = produtoId;
        document.getElementById('edit_quantidade_venda').value = qtd;
        document.getElementById('edit_preco_venda').value = (typeof formatarMoedaParaExibir === 'function' ? formatarMoedaParaExibir(preco) : preco) || preco;
        document.getElementById('edit_nf').value = nf;
        document.getElementById('edit_data_venda').value = data;
        document.getElementById('edit_empresa_faturadora').value = empresa;
        document.getElementById('edit_situacao').value = situacao;
        var editFormaPag = document.getElementById('edit_forma_pagamento');
        if (editFormaPag) editFormaPag.value = formaPagamento;

        wrap.classList.remove('hidden');
        document.body.style.overflow = 'hidden';
        if (typeof lucide !== 'undefined') lucide.createIcons();
    }
})();
</script>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
// Gr√°ficos Doughnut (Situa√ß√£o, Forma de Pagamento, Empresa Faturadora)
(function() {
    var dados = {{ (graficos_data or {'situacao': {}, 'pagamento': {}, 'empresa': {}}) | tojson | safe }};
    var coresElegantes = [
        '#10B981', // Emerald 500
        '#3B82F6', // Blue 500
        '#F59E0B', // Amber 500
        '#EF4444', // Red 500
        '#8B5CF6', // Violet 500
        '#64748B'  // Slate 500
    ];
    function criarGrafico(idElemento, dadosObjeto) {
        const ctx = document.getElementById(idElemento);
        if (!ctx || !dadosObjeto || Object.keys(dadosObjeto).length === 0) return;
        
        const labelsOriginais = Object.keys(dadosObjeto);
        const valoresTotais = labelsOriginais.map(k => dadosObjeto[k].total);
        const valoresCount = labelsOriginais.map(k => dadosObjeto[k].count);
        
        // Calcula a soma financeira total daquele gr√°fico
        const somaGeral = valoresTotais.reduce((acc, val) => acc + val, 0);
        
        // Formatador para Reais Brasileiros
        const formatarMoeda = (valor) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(valor);
        // Cria as labels com o R$ e a %
        const labelsComDetalhes = labelsOriginais.map((label, index) => {
            const totalCategoria = valoresTotais[index];
            const porcentagem = somaGeral > 0 ? ((totalCategoria / somaGeral) * 100).toFixed(1) : 0;
            return `${label}: ${formatarMoeda(totalCategoria)} (${porcentagem}%)`;
        });
        
        new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: labelsComDetalhes,
                datasets: [{
                    data: valoresTotais,
                    backgroundColor: coresElegantes,
                    borderWidth: 0,
                    hoverOffset: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '65%',
                plugins: {
                    legend: { 
                        position: 'bottom', 
                        labels: { boxWidth: 12, usePointStyle: true, color: '#6B7280', font: { size: 11 } } 
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const index = context.dataIndex;
                                const totalCategoria = valoresTotais[index];
                                const countCategoria = valoresCount[index];
                                const porcentagem = somaGeral > 0 ? ((totalCategoria / somaGeral) * 100).toFixed(1) : 0;
                                return ` ${countCategoria} venda(s) - ${formatarMoeda(totalCategoria)} (${porcentagem}%)`;
                            }
                        }
                    }
                }
            }
        });
    }
    criarGrafico('chartSituacao', dados.situacao);
    criarGrafico('chartPagamento', dados.pagamento);
    criarGrafico('chartEmpresa', dados.empresa);
})();
</script>
{% endblock %}
