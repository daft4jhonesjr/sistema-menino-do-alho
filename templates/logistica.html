{% extends 'base.html' %}

{% block title %}Logística - Menino do Alho{% endblock %}

{% block content %}
<div class="mb-6 flex flex-col md:flex-row md:justify-between md:items-end gap-4">
    <div>
        <h2 class="text-2xl font-bold text-gray-800 dark:text-gray-100">Logística e Entregas</h2>
        <p class="text-gray-500 dark:text-gray-400">Gerencie o envio dos pedidos e gere rotas otimizadas.</p>
    </div>

    <div class="flex flex-col sm:flex-row items-stretch sm:items-center gap-3 w-full md:w-auto">

        <div class="flex bg-gray-100 dark:bg-gray-800 rounded-lg p-1 border border-gray-200 dark:border-gray-700 w-full sm:w-auto justify-center">
            <a href="{{ url_for('logistica', status='PENDENTE') }}" class="flex-1 text-center px-4 py-2 rounded-md text-sm font-medium transition-colors {% if filtro_status == 'PENDENTE' %}bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 shadow-sm{% else %}text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200{% endif %}">Pendentes</a>
            <a href="{{ url_for('logistica', status='ENTREGUE') }}" class="flex-1 text-center px-4 py-2 rounded-md text-sm font-medium transition-colors {% if filtro_status == 'ENTREGUE' %}bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 shadow-sm{% else %}text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200{% endif %}">Já Entregues</a>
        </div>

        <div class="flex flex-col sm:flex-row items-stretch sm:items-center gap-2 w-full sm:w-auto">
            {% if filtro_status == 'PENDENTE' %}
            <button type="button" onclick="atualizarStatusMassa('ENTREGUE')" class="w-full sm:w-auto justify-center bg-emerald-100 hover:bg-emerald-200 text-emerald-800 dark:bg-emerald-900/40 dark:hover:bg-emerald-900/60 dark:text-emerald-300 px-4 py-2.5 rounded-lg text-sm font-semibold shadow-sm flex items-center gap-2 transition-colors">
                <svg class="w-4 h-4 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                <span class="whitespace-nowrap">Entregar Selecionados</span>
            </button>
            <button type="button" onclick="gerarRotaMaps()" class="w-full sm:w-auto justify-center bg-emerald-600 hover:bg-emerald-700 text-white px-5 py-2.5 rounded-lg text-sm font-semibold shadow-lg shadow-emerald-500/30 flex items-center gap-2 transition-colors">
                <svg class="w-4 h-4 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path></svg>
                <span class="whitespace-nowrap">Rota no Maps</span>
            </button>
            {% else %}
            <button type="button" onclick="atualizarStatusMassa('PENDENTE')" class="w-full sm:w-auto justify-center bg-gray-200 hover:bg-gray-300 text-gray-800 dark:bg-gray-700 dark:hover:bg-gray-600 dark:text-gray-200 px-4 py-2.5 rounded-lg text-sm font-semibold shadow-sm flex items-center gap-2 transition-colors">
                <svg class="w-4 h-4 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                <span class="whitespace-nowrap">Desfazer Selecionados</span>
            </button>
            {% endif %}
        </div>
    </div>
</div>

<div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 shadow-sm dark:shadow-none overflow-hidden">
    <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
            <thead class="bg-gray-50 dark:bg-gray-900/50">
                <tr>
                    <th class="px-4 py-3 text-left w-12">
                        <input type="checkbox" id="check-all-entregas" class="rounded border-gray-300 dark:border-gray-600 text-emerald-600 focus:ring-emerald-500" title="Selecionar todos">
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Data</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Cliente</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Endereço</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Produto</th>
                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Total</th>
                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Ações</th>
                </tr>
            </thead>
            <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                {% for e in entregas %}
                <tr class="hover:bg-emerald-50 dark:hover:bg-emerald-900/20 transition">
                    <td class="px-4 py-4">
                        <input type="checkbox" class="check-entrega rounded border-gray-300 dark:border-gray-600 text-emerald-600 focus:ring-emerald-500" value="{{ e.venda_id }}" data-endereco="{{ e.endereco }}">
                    </td>
                    <td class="px-6 py-4 text-sm text-gray-700 dark:text-gray-300">{{ e.data }}</td>
                    <td class="px-6 py-4 text-sm font-medium text-gray-900 dark:text-gray-100">{{ e.cliente_nome }}</td>
                    <td class="px-6 py-4 text-sm text-gray-600 dark:text-gray-400">{{ e.endereco or '—' }}</td>
                    <td class="px-6 py-4 text-sm text-gray-700 dark:text-gray-300">{{ e.produto }}</td>
                    <td class="px-6 py-4 text-sm font-semibold text-emerald-600 dark:text-emerald-400 text-right">{{ e.total | formato_moeda }}</td>
                    <td class="px-6 py-4 text-center">
                        <form method="post" action="{{ url_for('toggle_entrega', venda_id=e.venda_id, status=filtro_status) }}" class="inline" onsubmit="return confirm('{% if filtro_status == 'PENDENTE' %}Tem certeza que deseja marcar este pedido como ENTREGUE?{% else %}Tem certeza que deseja desfazer e voltar o pedido para PENDENTE?{% endif %}');">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                            {% if filtro_status == 'PENDENTE' %}
                            <button type="submit" class="text-emerald-600 hover:text-emerald-700 dark:text-emerald-400 dark:hover:text-emerald-300 text-sm font-medium">Marcar como Entregue</button>
                            {% else %}
                            <button type="submit" class="text-amber-600 hover:text-amber-700 dark:text-amber-400 dark:hover:text-amber-300 text-sm font-medium">Reverter</button>
                            {% endif %}
                        </form>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="7" class="px-6 py-12 text-center text-gray-500 dark:text-gray-400">
                        {% if filtro_status == 'PENDENTE' %}
                        Nenhum pedido pendente de entrega.
                        {% else %}
                        Nenhum pedido entregue.
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script>
(function() {
    var checkAll = document.getElementById('check-all-entregas');
    var checks = document.querySelectorAll('.check-entrega');
    if (checkAll && checks.length) {
        checkAll.addEventListener('change', function() {
            checks.forEach(function(cb) { cb.checked = checkAll.checked; });
        });
    }
    if (typeof lucide !== 'undefined') lucide.createIcons();
})();

function gerarRotaMaps() {
    const selecionados = document.querySelectorAll('.check-entrega:checked');
    const enderecos = [];

    const vistos = new Set();
    selecionados.forEach(cb => {
        const end = cb.dataset.endereco;
        // Evita duplicidade se o cliente tiver 2 pedidos
        if (end && end.trim() !== '' && !vistos.has(end.trim())) {
            vistos.add(end.trim());
            enderecos.push(encodeURIComponent(end));
        }
    });

    if (enderecos.length === 0) {
        alert('Selecione pelo menos um pedido com endereço válido para gerar a rota!');
        return;
    }

    // URL base oficial para rotas (Directions)
    let url = "https://www.google.com/maps/dir/?api=1&travelmode=driving";
    // Remove o último item do array para ser o destino final
    const destination = enderecos.pop();
    url += "&destination=" + destination;

    // Se sobrar endereços, adiciona como paradas (waypoints) separadas por | (%7C)
    if (enderecos.length > 0) {
        const waypoints = enderecos.join('%7C');
        url += "&waypoints=" + waypoints;
    }

    window.open(url, '_blank');
}

function atualizarStatusMassa(novoStatus) {
    const selecionados = document.querySelectorAll('.check-entrega:checked');
    const ids = Array.from(selecionados).map(cb => cb.value);

    if (ids.length === 0) {
        alert('Selecione pelo menos um pedido!');
        return;
    }

    const textoAcao = novoStatus === 'ENTREGUE' ? 'marcar como ENTREGUE' : 'voltar para PENDENTE';
    if (!confirm(`Tem certeza que deseja ${textoAcao} os ${ids.length} pedidos selecionados?`)) {
        return;
    }

    fetch("{{ url_for('logistica_bulk_update') }}", {
        method: 'POST',
        headers: Object.assign({ 'Content-Type': 'application/json' }, window.getCsrfHeaders ? window.getCsrfHeaders() : {}),
        body: JSON.stringify({ ids: ids, status: novoStatus })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            window.location.reload();
        } else {
            alert('Erro: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        alert('Erro ao processar a solicitação no servidor.');
    });
}
</script>
{% endblock %}
