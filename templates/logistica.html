{% extends 'base.html' %}

{% block title %}Logística - Menino do Alho{% endblock %}

{% block content %}
<div class="mb-8 flex justify-between items-end flex-wrap gap-4">
    <div>
        <h2 class="text-2xl font-bold text-emerald-700 dark:text-emerald-400 mb-2">Logística e Entregas</h2>
        <p class="text-gray-500 dark:text-gray-400">Selecione os clientes para gerar a rota otimizada de hoje.</p>
    </div>
    <button type="button" onclick="gerarRotaMaps()" class="bg-emerald-600 hover:bg-emerald-700 text-white px-6 py-2.5 rounded-lg font-medium shadow-lg shadow-emerald-500/30 flex items-center gap-2 transition-colors">
        <i data-lucide="map-pin" class="w-5 h-5"></i>
        Gerar Rota no Maps
    </button>
</div>

<div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 shadow-sm dark:shadow-none overflow-hidden">
    <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
            <thead class="bg-gray-50 dark:bg-gray-900/50">
                <tr>
                    <th class="px-4 py-3 text-left w-12">
                        <input type="checkbox" id="check-all-entregas" class="rounded border-gray-300 dark:border-gray-600 text-emerald-600 focus:ring-emerald-500" title="Selecionar todos">
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Cliente</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Endereço</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Produtos</th>
                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Total</th>
                </tr>
            </thead>
            <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                {% for entrega in entregas %}
                <tr class="hover:bg-emerald-50 dark:hover:bg-emerald-900/20 transition">
                    <td class="px-4 py-4">
                        <input type="checkbox" class="check-entrega rounded border-gray-300 dark:border-gray-600 text-emerald-600 focus:ring-emerald-500" data-endereco="{{ entrega.endereco }}">
                    </td>
                    <td class="px-6 py-4 text-sm font-medium text-gray-900 dark:text-gray-100">{{ entrega.cliente_nome }}</td>
                    <td class="px-6 py-4 text-sm text-gray-600 dark:text-gray-400">{{ entrega.endereco }}</td>
                    <td class="px-6 py-4 text-sm text-gray-700 dark:text-gray-300">
                        <ul class="list-disc list-inside space-y-0.5">
                            {% for p in entrega.produtos %}
                            <li>{{ p }}</li>
                            {% endfor %}
                        </ul>
                    </td>
                    <td class="px-6 py-4 text-sm font-semibold text-emerald-600 dark:text-emerald-400 text-right">{{ entrega.total | formato_moeda }}</td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="5" class="px-6 py-12 text-center text-gray-500 dark:text-gray-400">
                        Nenhuma entrega pendente com endereço cadastrado. Cadastre o endereço dos clientes para gerar rotas.
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script>
(function() {
    var checkAll = document.getElementById('check-all-entregas');
    var checks = document.querySelectorAll('.check-entrega');
    if (checkAll && checks.length) {
        checkAll.addEventListener('change', function() {
            checks.forEach(function(cb) { cb.checked = checkAll.checked; });
        });
    }
    if (typeof lucide !== 'undefined') lucide.createIcons();
})();

function gerarRotaMaps() {
    var selecionados = document.querySelectorAll('.check-entrega:checked');
    var enderecos = [];

    selecionados.forEach(function(cb) {
        var end = cb.getAttribute('data-endereco');
        if (end && end.trim() !== '' && enderecos.indexOf(end) === -1) {
            enderecos.push(encodeURIComponent(end));
        }
    });

    if (enderecos.length === 0) {
        alert('Selecione pelo menos um cliente para gerar a rota!');
        return;
    }

    var url = 'https://www.google.com/maps/dir/?api=1';
    if (enderecos.length === 1) {
        url += '&destination=' + enderecos[0];
    } else {
        var destination = enderecos.pop();
        var waypoints = enderecos.join('|');
        url += '&destination=' + destination + '&waypoints=' + waypoints;
    }

    window.open(url, '_blank');
}
</script>
{% endblock %}
